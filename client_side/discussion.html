<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Threaded Opinions ‚Äî Modern Chat Layout</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #151821;
      --panel-2: #10131a;
      --text: #e6e9ef;
      --muted: #a3aab9;
      --border: #232735;
      --primary: #7c5cff;
      --primary-2: #a590ff;
      --success: #22c55e;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 10px;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --panel-2: #fbfbfe;
        --text: #0b1020;
        --muted: #606a80;
        --border: #e6e8ee;
        --shadow: 0 10px 30px rgba(9, 12, 22, .08);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 700px at 80% -200px, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(1000px 500px at -200px 80%, rgba(79,209,197,.18), transparent 60%),
                  var(--bg);
      line-height: 1.5;
    }

    /* Layout */
    .shell {
      max-width: 1100px;
      margin: min(6vh, 48px) auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }

    .topic-card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 2px 18px;
      position: sticky;
      top: 10px;
      z-index: 1;
    }

    .topic-heading {
      display: flex;
      align-items: start;
      gap: 14px;
    }
    .topic-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      display: grid; place-items: center;
      background: linear-gradient(145deg, rgba(124,92,255,.25), rgba(124,92,255,.05));
      border: 1px solid var(--border);
      flex: 0 0 auto;
    }
    .topic-title {
      margin: 0;
      font-size: clamp(22px, 2.5vw, 28px);
      letter-spacing: -0.01em;
    }
    .topic-meta {
      margin-top: 4px;
      color: var(--muted);
      font-size: 14px;
    }

    .toolbar {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .toolbar .controls { display: flex; gap: 10px; flex-wrap: wrap; }

    .chip {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
    }

    .select {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }

    .list-card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    /* Post item */
    .post {
      display: grid;
      grid-template-columns: 48px 1fr;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      transition: border-color .2s ease, background .2s ease;
    }
    .post + .post { margin-top: 6px; }
    .post:hover { border-color: var(--border); background: rgba(124,92,255,.03); }

    .avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(145deg, #d1d5db, #9ca3af);
      display: grid; place-items: center;
      color: #0b0c10; font-weight: 700;
      user-select: none;
    }

    .post-body { min-width: 0; }

    .post-head {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .name { font-weight: 700; }
    .badge {
      font-size: 12px; padding: 2px 8px; border-radius: 999px;
      border: 1px solid var(--border); color: var(--muted);
    }
    .time { color: var(--muted); font-size: 13px; margin-left: auto; }

    .content { margin-top: 6px; font-size: 15.5px; }

    .attachments { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .pill {
      font-size: 12px; border: 1px dashed var(--border); color: var(--muted);
      padding: 6px 10px; border-radius: 999px;
    }

    .post-actions {
      margin-top: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: transparent; color: var(--text); cursor: pointer; font-size: 14px;
    }
    .btn.primary { border-color: transparent; background: linear-gradient(145deg, var(--primary), var(--primary-2)); color: white; }
    .btn.ghost { opacity: .85; }
    .btn[aria-pressed="true"] { box-shadow: inset 0 0 0 2px currentColor; }

    .score { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: var(--muted); margin-left: 2px; }
    .score .up { color: var(--success); }
    .score .down { color: var(--danger); }

    /* Replies */
    .replies {
      margin-top: 10px; padding-left: 18px; border-left: 2px dashed var(--border);
      display: grid; gap: 8px;
    }

    /* Composer */
    .composer {
      margin-top: 12px;
      display: grid; grid-template-columns: 48px 1fr; gap: 12px;
      padding: 12px; border: 1px dashed var(--border); border-radius: var(--radius-sm);
      background: rgba(124,92,255,.05);
    }
    textarea.input {
      width: 100%; min-height: 64px; resize: vertical;
      background: var(--panel-2); color: var(--text);
      border: 1px solid var(--border); border-radius: 12px;
      padding: 10px 12px; font: inherit;
    }
    .composer-actions { margin-top: 8px; display: flex; gap: 8px; align-items: center; justify-content: flex-end; }

    /* Utilities */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); border: 0; }
    .spacer { flex: 1; }

    /* Responsive tweaks */
    @media (max-width: 720px) {
      .topic-card { position: static; }
      .time { width: 100%; margin-left: 0; }
      .composer { grid-template-columns: 36px 1fr; }
      .avatar { width: 36px; height: 36px; font-size: 12px; }
      .post { grid-template-columns: 36px 1fr; }
    }

    .topic-description {
    margin-top: 10px;
    font-size: 14px;
    color: var(--muted);
    }
    .topic-description p {
    margin: 0;
    }

  </style>
</head>
<body>
  <div class="shell" role="application" aria-label="Threaded opinions" id="app">

    <!-- Topic/Header + Disagreement Switcher -->
    <section class="topic-card" aria-labelledby="topic-title">
      <div class="topic-heading">
        <div class="topic-icon" aria-hidden="true">üí¨</div>
        <div>
          <h1 id="topic-title" class="topic-title">Loading disagreements‚Ä¶</h1>
          <div class="topic-meta" id="topic-meta">Single-subject thread ‚Ä¢ <span id="opinion-count">0</span> opinions ‚Ä¢ Last sync <span id="last-sync">‚Äî</span></div>
        </div>
      </div>

      <div id="topic-description" class="topic-description"></div>

      <!-- Rectangular boxes menu for disagreements -->
      <div class="toolbar" aria-label="Disagreements switcher">
        <div class="controls" id="disagreements-menu" style="overflow:auto; white-space:nowrap; padding-bottom:6px; width:100%">
          <!-- buttons inserted dynamically -->
        </div>
      </div>
    </section>

    <!-- Opinions List (dynamic) -->
    <section class="list-card" aria-live="polite">
      <div id="posts"></div>
    </section>

    <!-- New Opinion Composer (root-level) -->
    <section class="list-card" aria-label="Add new opinion">
      <div class="composer">
        <div class="avatar" aria-hidden="true" id="you-avatar">YOU</div>
        <div style="width:100%">
          <label class="sr-only" for="new-opinion">Share your opinion</label>
          <textarea id="new-opinion" class="input" placeholder="Share your opinion‚Ä¶"></textarea>
          <div class="composer-actions">
            <button class="btn" id="attach-btn" disabled>Attach</button>
            <span class="spacer"></span>
            <button class="btn primary" id="post-root">Post opinion</button>
          </div>
        </div>
      </div>
    </section>

  </div>

  <script src="js/disagreements.js"></script>

  <script>
    /* ===== Auth helpers (provided) ===== */
    function isLoggedIn() {
      const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName');
      const order = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder');
      return name && order;
    }
    function checkLogin() {
      if (!isLoggedIn()) {
        alert('You must be logged in to access this page. Redirecting to the homepage.');
        window.location.href = 'https://codecomprehensibility.site/';
      }
    }

    /* ===== Config ===== */
    const CONFIG = {
      DISAGREEMENTS_URL: 'js/disagreements.json',
      GET_LATEST_CHAT_URL: 'https://codecomprehensibility.site/get_latest_chat',
      SUBMIT_CHAT_URL: 'https://codecomprehensibility.site/submit_chat',   // TODO: confirm
      DELETE_CHAT_URL: 'https://codecomprehensibility.site/delete_chat',   // TODO: confirm
      POLL_MS: 120000
    };

    /* ===== App state ===== */
    const state = {
      user: {
        name: sessionStorage.getItem('participantName') || localStorage.getItem('participantName') || 'You'
      },
      disagreements: [],           // {id, title, snippet_id, htmltext}
      currentId: null,
      chatsByDisagreement: {},     // { [disagreementId]: [messages] }
      pollHandle: null
    };

    /* ===== Utility ===== */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function fmtTime(dtStr) {
      try { const d = new Date(dtStr); return d.toLocaleString(); } catch { return 'just now'; }
    }

    // Build a thread tree from flat messages
    function buildThread(messages) {
      const byId = new Map();
      const roots = [];
      messages.forEach(m => {
        m.children = [];
        byId.set(m.id, m);
      });
      messages.forEach(m => {
        if (m.parentId) {
          const p = byId.get(m.parentId);
          if (p) p.children.push(m); else roots.push(m); // orphan safeguard
        } else {
          roots.push(m);
        }
      });
      // sort by time ascending within each level (server may already do)
      const sortRec = nodes => {
        nodes.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
        nodes.forEach(n => sortRec(n.children));
      };
      sortRec(roots);
      return roots;
    }

    function renderDisagreementsMenu() {
      const menu = $('#disagreements-menu');
      menu.innerHTML = '';
      state.disagreements.forEach(d => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.textContent = `${d.title}`;
        btn.setAttribute('data-id', d.id);
        btn.setAttribute('aria-pressed', String(d.id === state.currentId));
        btn.style.borderRadius = '10px';
        btn.style.display = 'inline-flex';
        btn.style.marginRight = '8px';
        btn.onclick = () => switchDisagreement(d.id);
        menu.appendChild(btn);
      });
    }

    function switchDisagreement(id) {
    state.currentId = id;
    // update pressed states
    $$('#disagreements-menu .chip').forEach(b => b.setAttribute('aria-pressed', String(b.getAttribute('data-id') == id)));

    const meta = $('#topic-meta');
    const topicTitle = $('#topic-title');
    const d = state.disagreements.find(x => String(x.id) === String(id));
    if (d) {
        topicTitle.textContent = d.title;
        meta.innerHTML = `Snippet ${d['snippet-id'] ?? d.snippet_id ?? '‚Äî'} ‚Ä¢ <span id="opinion-count">0</span> opinions ‚Ä¢ Last sync <span id="last-sync">‚Äî</span>`;
        
        $('#topic-description').innerHTML = d.htmltext || '';
    }
    renderCurrentThread();
    }

    function renderCurrentThread() {
      const posts = $('#posts');
      posts.innerHTML = '';
      const msgs = state.chatsByDisagreement[state.currentId] || [];
      const thread = buildThread(msgs);
      $('#opinion-count').textContent = msgs.length;
      $('#last-sync').textContent = new Date().toLocaleTimeString();
      thread.forEach(node => posts.appendChild(renderMessage(node)));
    }

    function renderMessage(msg) {
      const el = document.createElement('article');
      el.className = 'post';
      el.dataset.id = msg.id;
      el.innerHTML = `
        <div class="avatar" aria-hidden="true">${(msg.username || '?').slice(0,2).toUpperCase()}</div>
        <div class="post-body">
          <div class="post-head">
            <span class="name">${msg.username || 'Unknown'}</span>
            ${msg.role ? `<span class="badge">${msg.role}</span>` : ''}
            <time class="time" datetime="${msg.createdAt || ''}">${fmtTime(msg.createdAt)}</time>
          </div>
          <div class="content">${msg.is_deleted ? '<em style="color:var(--muted)">[message deleted]</em>' : escapeHtml(msg.content || '')}</div>
          <div class="post-actions">
            <button class="btn" onclick="vote(this, 1)">üëç Like</button>
            <button class="btn" onclick="vote(this, -1)">üëé Dislike</button>
            <span class="score"><span class="up" data-up>${msg.up || 0}</span>/<span class="down" data-down>${msg.down || 0}</span></span>
            <span class="spacer"></span>
            ${ msg.is_deleted ? '' : `<button class="btn ghost" onclick="toggleReply(this)">‚Ü©Ô∏é Reply</button>` }
            ${ (msg.username === state.user.name && !msg.is_deleted) ? `<button class="btn ghost" onclick="requestDelete('${msg.id}')">üóë Delete</button>` : ''}
            <button class="btn ghost">‚ãØ</button>
          </div>
        </div>`;

      // Replies container
      const repliesWrap = document.createElement('div');
      repliesWrap.className = 'replies';
      (msg.children || []).forEach(c => repliesWrap.appendChild(renderMessage(c)));
      el.querySelector('.post-body').appendChild(repliesWrap);

      // Inline composer (only if not deleted)
      if (!msg.is_deleted) {
        const composer = document.createElement('div');
        composer.className = 'composer';
        composer.hidden = true;
        composer.innerHTML = `
          <div class="avatar" aria-hidden="true">${(state.user.name||'YO').slice(0,3).toUpperCase()}</div>
          <div>
            <label class="sr-only">Write a reply</label>
            <textarea class="input" placeholder="Write a thoughtful reply‚Ä¶"></textarea>
            <div class="composer-actions">
              <button class="btn" onclick="cancelReply(this)">Cancel</button>
              <button class="btn primary" onclick="submitReply(this, '${msg.id}')">Post reply</button>
            </div>
          </div>`;
        el.querySelector('.post-body').appendChild(composer);
      }
      return el;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    /* ===== Network ===== */
function loadDisagreements() {
  const arr = window.DISAGREEMENTS || [];
  state.disagreements = arr.map(d => ({
    id: d.id,
    title: d.title,
    snippet_id: d["snippet-id"] ?? d.snippet_id,
    htmltext: d.htmltext
  }));
  if (!state.currentId && state.disagreements.length) {
    state.currentId = state.disagreements[0].id;
  }
  renderDisagreementsMenu();
  const first = state.disagreements.find(x => x.id === state.currentId);
    if (first) {
        $('#topic-title').textContent = first.title;
        $('#topic-description').innerHTML = first.htmltext || '';
    }

}


    async function fetchLatestChat() {
      const payload = { username: state.user.name };
      const res = await fetch(CONFIG.GET_LATEST_CHAT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        // credentials: 'include' // if needed
      });
      if (!res.ok) throw new Error('Failed to get latest chat');
      const data = await res.json();
      // Expected shape: { chats: { [disagreementId]: [ {id,parentId,username,content,createdAt,is_deleted,up,down,role} ] } }
      state.chatsByDisagreement = data.chats || {};
      renderCurrentThread();
    }

    async function sendMessage({ disagreementId, parentId=null, content }) {
      const payload = { username: state.user.name, disagreementId, parentId, content };
      const res = await fetch(CONFIG.SUBMIT_CHAT_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!res.ok) { alert('Failed to send message'); return; }
      const data = await res.json();
      // Assume server returns updated structure compatible with fetchLatestChat
      if (data?.chats) {
        state.chatsByDisagreement = data.chats;
      } else {
        await fetchLatestChat();
      }
      renderCurrentThread();
    }

    async function deleteMessage(id) {
      const payload = { username: state.user.name, messageId: id };
      const res = await fetch(CONFIG.DELETE_CHAT_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!res.ok) { alert('Delete failed'); return; }
      await fetchLatestChat();
    }

    // Button handlers exposed globally
    window.vote = function(el, delta) {
      const post = el.closest('.post');
      const up = post.querySelector('[data-up]');
      const down = post.querySelector('[data-down]');
      const upN = parseInt(up?.textContent || '0', 10);
      const downN = parseInt(down?.textContent || '0', 10);
      if (delta > 0) up.textContent = upN + 1; else down.textContent = downN + 1;
    }
    window.toggleReply = function(btn) {
      const post = btn.closest('.post');
      const composer = post.querySelector('.composer');
      if (composer) composer.hidden = !composer.hidden;
    }
    window.cancelReply = function(el) {
      const card = el.closest('.composer');
      const ta = card.querySelector('textarea');
      ta.value = '';
      card.hidden = true;
    }
    window.submitReply = function(btn, parentId) {
      const composer = btn.closest('.composer');
      const text = composer.querySelector('textarea').value.trim();
      if (!text) return;
      sendMessage({ disagreementId: state.currentId, parentId, content: text });
    }
    window.requestDelete = function(id) {
      if (confirm('Delete your message? It will appear as [message deleted] but replies remain.')) deleteMessage(id);
    }

    // Root composer
    function bindRootComposer() {
      $('#post-root').addEventListener('click', () => {
        const ta = $('#new-opinion');
        const text = ta.value.trim();
        if (!text) return;
        sendMessage({ disagreementId: state.currentId, parentId: null, content: text });
        ta.value = '';
      });
    }

    async function init() {
      checkLogin();
      $('#you-avatar').textContent = (state.user.name || 'YOU').slice(0,3).toUpperCase();
      bindRootComposer();
      await loadDisagreements();
      await fetchLatestChat().catch(console.error);
      if (state.pollHandle) clearInterval(state.pollHandle);
      state.pollHandle = setInterval(() => fetchLatestChat().catch(console.error), CONFIG.POLL_MS);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
