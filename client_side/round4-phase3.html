<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phase 3: Reflect on Expert Disagreements</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 40px 40px 40px;
      /* top right bottom left */
      background-color: #f4f4f4;
      color: #333;
    }
  
    .instructions {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  
    .ranking-row {
      display: flex;
      gap: 10px;
      overflow-x: visible;
      margin-bottom: 10px;
    }
  
    .ranking-row-numbers {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }

    .ranking-number {
      flex: 1;
      text-align: center;
      color: #009999;
    }
  
    .card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      margin: 5px;
      cursor: grab;
    }
  
    .card.dragging {
      opacity: 0.5;
    }
  
    .preview-area {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
  
    .snippet-preview-box {
      flex: 1 1 45%;
      min-width: 300px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
      border: 1px solid #ddd;
    }
  
    .snippet-header {
      background-color: #f5f5f5;
      padding: 10px 15px;
      font-weight: bold;
      font-size: 16px;
      border-bottom: 1px solid #ccc;
    }
  
    .code-box {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      overflow-x: auto;
      padding: 15px;
      font-size: 14px;
      color: #333;
      background-color: #f9f9f9;
    }
  
    #theme-toggle {
      background-color: #333;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }
  
    #continueBtn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 10px #4CAF50;
    }
  
    #continueBtn:hover {
      background-color: #45a049;
      animation: glowPulse 1.5s infinite alternate;
    }
  
    @keyframes glowPulse {
      0% {
        box-shadow: 0 0 10px #4CAF50;
      }
  
      100% {
        box-shadow: 0 0 20px #4CAF50, 0 0 30px #4CAF50;
      }
    }
  
    /*.status-bar {
        background-color: #333;
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 0;
        position: static; 
      }*/
  
    .status-bar {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
  
    .phase-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
  
    .phase-link:hover:not(.disabled) {
      background-color: #4CAF50;
    }
  
    .phase-link.active {
      background-color: #4CAF50;
    }
  
    .phase-link.disabled {
      pointer-events: none;
      opacity: 0.5;
      cursor: not-allowed;
    }
  
    /*For snippet cards*/
    #cards {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 10px 0;
      flex-wrap: nowrap;
    }
  
    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
  
    button:hover {
      background-color: #45a049;
    }
  
    button[disabled] {
      background-color: #888;
      cursor: not-allowed;
    }
  
    /*dark/light mode*/
    /* Light mode preview styles */
    /* === Default (light mode) === */
    .card {
      background-color: #ffffff;
      border-color: #ccc;
      color: #333;
    }
  
    .snippet-preview-box {
      background-color: #fefefe;
      border: 1px solid #bbb;
    }
  
    .code-box {
      background-color: #f9f9f9;
      color: #222;
    }
  
    /* === Dark mode overrides === */
    body.dark-mode .card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #ddd;
    }
  
    body.dark-mode .snippet-preview-box {
      background-color: #1e1e1e;
      border: 1px solid #444;
    }
  
    body.dark-mode .code-box {
      background-color: #2d2d2d;
      color: #ddd;
    }
  
  
    /*code box*/
    /* Basic syntax highlighting classes */
    .keyword {
      color: #0000ff;
      font-weight: bold;
    }
  
    .type {
      color: #007070;
    }
  
    .function {
      color: #7928a1;
      font-weight: bold;
    }
  
    .literal {
      color: #009999;
    }
  
    .string {
      color: #a31515;
    }
  
    .comment {
      color: #6a9955;
      font-style: italic;
    }
  
    .number {
      color: #098658;
    }
  
    /* Dark mode overrides */
    .dark-mode .keyword {
      color: #82aaff;
    }
  
    .dark-mode .type {
      color: #89ddff;
    }
  
    .dark-mode .function {
      color: #c792ea;
    }
  
    .dark-mode .literal {
      color: #ffcb6b;
    }
  
    .dark-mode .string {
      color: #c3e88d;
    }
  
    .dark-mode .comment {
      color: #7f848e;
    }
  
    .dark-mode .number {
      color: #f78c6c;
    }
  
    html {
      scroll-behavior: smooth;
    }
  
    a {
      color: #4CAF50;
      text-decoration: none;
    }
  
    a:hover {
      text-decoration: underline;
    }

      .participant-section {
      margin-bottom: 10px;
    }

    .participant-section-wide{
      height: 100px;
    }

    .ranking-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .ranking-labels {
      display: flex;
      gap: 10px;
      margin-bottom: 5px;
    }

    .ranking-label {
      flex: 1;
      text-align: center;
      font-weight: bold;
      color: #009999;
    }

    .ranking-slot {
      flex: 1;
      min-height: 30px;
      border: 2px dashed #4CAF50;
      background-color: #e8f5e9;
      border-radius: 6px;
      padding-left: 1px;
      padding-right: 1px;

      display: flex;           /* make contents align inline */
      flex-wrap: wrap;         /* allow wrapping to next line */
      gap: 5px;                /* optional: spacing between items */
      justify-content: center; /* optional: center items horizontally */
      align-items: center;     /* optional: center items vertically */
    }

    .ranking-slot button {
      display: inline-block;         /* allows buttons to sit next to each other */
      width: auto;                   /* removes the full-width constraint */
      margin: 1px;                   /* spacing around each button */
      padding: 1px 5px;             /* more natural button padding */
      border: none;
      border-radius: 4px;
      background-color: #4CAF50;
      color: white;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      flex: 0 0 auto;                /* optional: don't grow/shrink in flex layout */
    }


    .ranking-slot button:hover {
      background-color: #45a049;
      position: relative;
    }

    .ranking-label:last-child {
      color: red;
    }

    .snippet-1 { background-color: #4CAF50; color: white; } /* Green */
    .snippet-2 { background-color: #2196F3; color: white; } /* Blue */
    .snippet-3 { background-color: #f44336; color: white; } /* Red */
    .snippet-4 { background-color: #FF9800; color: white; } /* Orange */
    .snippet-5 { background-color: #9C27B0; color: white; } /* Purple */
    .snippet-6 { background-color: #3F51B5; color: white; } /* Indigo */
    .snippet-7 { background-color: #009688; color: white; } /* Teal */
    .snippet-8 { background-color: #795548; color: white; } /* Brown */

    button.snippet-1 { background-color: #4CAF50; color: white; }
    button.snippet-2 { background-color: #2196F3; color: white; }
    button.snippet-3 { background-color: #f44336; color: white; }
    button.snippet-4 { background-color: #FF9800; color: white; }
    button.snippet-5 { background-color: #9C27B0; color: white; }
    button.snippet-6 { background-color: #3F51B5; color: white; }
    button.snippet-7 { background-color: #009688; color: white; }
    button.snippet-8 { background-color: #795548; color: white; }


.reasoning-point {
  position: absolute;
  width: 10px;
  height: 10px;
  background: white;
  border: 2px solid black;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10;
  transition: transform 0.2s ease;
}

.reasoning-point:hover {
  transform: scale(1.2);
}

.tooltip-box {
  position: absolute;
  background-color: #333;
  color: white;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  max-width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
  z-index: 99;
}

.reasoning-container {
  position: relative;
}

/* Show tooltip on hover */
.reasoning-point:hover + .tooltip-box {
  display: block;
}

.snippet-box {
  background: #f9f9f9;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
  font-family: 'Courier New', monospace;
  white-space: pre-wrap;
  overflow-x: auto;
}

/*.code-content {*/
/*  background-color: #f0f0f0;*/
/*  padding: 10px;*/
/*  border-radius: 4px;*/
/*}*/

.participant {
      background: #f9f9f9;
      border-left: 4px solid #aaa;
      padding: 10px;
      margin-bottom: 10px;
    }
    .participant h4 {
      margin-top: 0;
    }


    #modal-code {
  background-color: #2d2d2d;
  color: #ccc;
  padding: 20px;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
  overflow-x: auto;
  font-family: 'Courier New', Courier, monospace;
  font-size: 15px;
  line-height: 1.5;
}

.light-mode #modal-code {
  background-color: #f0f0f0;
  color: #333;
}
.code-container {
  display: grid;
  grid-template-columns: auto 1fr;
  background-color: inherit;
  color: inherit;
  font-family: 'Courier New', Courier, monospace;
  font-size: 15px;
  line-height: 1.5;
  padding: 20px;
  overflow-x: auto;
}

.line-numbers {
  text-align: right;
  padding-right: 10px;
  user-select: none;
  color: #888;
}

.code-content {
  white-space: pre;
}

#code {
  background-color: #2d2d2d;
  color: #ccc;
  padding: 20px;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
  overflow-x: auto;
  font-family: 'Courier New', Courier, monospace;
  font-size: 15px;
  line-height: 1.5;
}

.light-mode #code {
  background-color: #f0f0f0;
  color: #333;
}
/* LIGHT MODE styles */
.keyword     { color: #0000ff; font-weight: bold; }
.type        { color: #007070; }
.function    { color: #7928a1; font-weight: bold; }
.literal     { color: #009999; }
.string      { color: #a31515; }
.comment     { color: #6a9955; font-style: italic; }
.number      { color: #098658; }

/* DARK MODE overrides */
.dark-mode .keyword  { color: #82aaff; }
.dark-mode .type     { color: #89ddff; }
.dark-mode .function { color: #c792ea; }
.dark-mode .literal  { color: #ffcb6b; }
.dark-mode .string   { color: #c3e88d; }
.dark-mode .comment  { color: #7f848e; }
.dark-mode .number   { color: #f78c6c; }

a {
    color: #4CAF50;
    text-decoration: none;
}
a:hover {
    text-decoration: underline;
}


.sticky-menu {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  padding: 10px 0;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: center;
  gap: 12px;
  z-index: 1000;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.06);
}

.sticky-menu button {
  background: #ffffff;
  color: #333;
  font-weight: 500;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}

.sticky-menu button:hover {
  background: #f3f3f3;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

    .disagreement-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .content-wrapper {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-top: 20px;
    }

    .disagreement-box, .question-box {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
      resize: vertical;
    }

    .question-box .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }
    .content-wrapper {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  margin-top: 20px;
}

.disagreement-box, .right-panel {
  flex: 1;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.question-box textarea {
  width: 100%;
  height: 120px;
  padding: 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 5px;
  resize: vertical;
}

.right-panel .navigation {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}


.toggle-btn {
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 5px;
  background-color: #ffc800;
  border: 1px solid #aaa;
  cursor: pointer;
  color: #222;
}

/* This is no longer fixed height */
.phase-bar {
  position: fixed;
  top: 50px;
  left: 0;
  right: 0;
  background: #fff;
  z-index: 999;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-bottom: 1px solid #ccc;
  transition: max-height 0.3s ease;
}

/* Static header */
.phase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
}

/* Collapsible section ‚Äî scrollable */


/* Slim header */
.phase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
}

/* Title inline */
.phase-title {
  font-weight: 600;
  color: #333;
}

/* body {
  margin-top: 140px;
} */

#scroll-trigger-element {
  opacity: 0;
  transition: opacity 0.4s ease;
  pointer-events: none;
}

#scroll-trigger-element.visible {
  opacity: 1;
  pointer-events: auto;
}


#phase-section-content {
  overflow: auto;
  min-height: 50px;
  height: 200px; /* default */
  resize: none;  /* disable built-in resizing ‚Äî we use custom handle */
  /* margin-bottom: 100px; */
  overflow-y: visible;
  padding: 10px 20px;
  /*display: none;*/
}

#phase2-resize-handle {
  height: 10px;
  background: #ccc;
  cursor: ns-resize;
  position: relative;
  /*display: none;*/
}

    .fade {
      transition: opacity 0.4s ease;
      opacity: 1;
    }
    .fade.hidden {
      opacity: 0;
    }

  </style>
</head>
<body>

<div class="status-bar">
  <div class="user-dropdown" style="position: relative;">
    <div style="padding: 8px 12px; color: gainsboro; font-weight: bold;"><span id="user-info"></span> (<button
        onclick="logout()"
        style="color: white; background: none; border: none; cursor: pointer; margin: 0;padding: 0;">üö™ Logout</button>)
    </div>
  </div>
  <a href="round4.html" class="phase-link" id="link-home">üè† Home</a>
  <a href="round4-phase1.html" class="phase-link" id="link-phase1">Phase 1</a>
  <a href="round4-phase2.html" class="phase-link disabled" id="link-phase2">Phase 2</a>
  <a href="round4-phase3.html" class="phase-link disabled" id="link-phase3">Phase 3</a>
  <a href="round4-phase4.html" class="phase-link disabled" id="link-phase4">Phase 4</a>
  <a href="round4-phase5.html" class="phase-link disabled" id="link-phase5">Phase 5</a>
  <a href="round4-review.html" class="phase-link disabled" id="link-review">Review & Submit</a>
</div>
<div id="scroll-trigger-element">
  <div id="phase2-section" class="phase-bar">
    <div class="phase-header">
      <span class="phase-title">üìå Need to revisit the rankings and reasoning? Click "Show" to view.</span>
      <button onclick="togglePhaseSection()" class="toggle-btn">Hide</button>
    </div>

    <div id="phase-section-content" class="phase-section" style="display:
    block;">
      <p>This is the collapsible content for Phase 3.</p>
    </div>

    <!-- üîß Grip to resize #phase-section-content -->
    <div id="phase2-resize-handle"></div>
  </div>
</div>




<div id="instructions-box" style="background-color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 80px;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">Phase 3: Reflect on Expert Disagreements</h2>
    <button id="instructions-content-btn" onclick="toggleInstructions()" style="padding: 6px 12px; font-size: 14px; border-radius: 5px; background-color: #ffffff; border: none; cursor: pointer; color: #222; border: solid;">Hide</button>
  </div>

  <div id="instructions-content" style="margin-top: 15px;">
  <p>In this phase, you will reflect on the disagreements between experts like yourself. For each disagreement point:</p>
  <ol>
    <li>Read the full explanation on the left.</li>
    <li><strong style="color: red">Don‚Äôt miss this:</strong> click <strong>‚ÄúView Round 2 Reflections‚Äù</strong> at the end of the explanation to see how experts discussed this disagreement in the previous round.</li>
    <li>Answer the questions on the right.</li>
    <li>Click ‚ÄúNext‚Äù to continue.</li>
  </ol>
  <p>While answering questions, use the sticky bar button to view the rankings and reasoning.</p>

    <!-- <p><strong>Important:</strong> Please fill the ranking positions from left to right. If you leave any positions empty (e.g., due to grouping multiple snippets in one position), leave the rightmost positions empty.</p> -->
     
          <p><strong>Please complete this phase using your own judgment</strong>. <span><strong>Do not consult with anyone else or use generative AI tools (ChatGPT, GitHub Copilot, etc.), search engines, or external websites</strong></span>. Your judgment is essential to the validity of our study.</p>
  </div>
</div>


  <div class="ranking-row-numbers" style="display: none;">
    <p class="ranking-number">Position 1 <span style="color: green;">(easiest)</span></p>
    <p class="ranking-number">Position 2</p>
    <p class="ranking-number">Position 3</p>
    <p class="ranking-number">Position 4</p>
    <p class="ranking-number">Position 5</p>
    <p class="ranking-number">Position 6</p>
    <p class="ranking-number">Position 7</p>
    <p class="ranking-number">Position 8 <span style="color: red;">(hardest)</span></p> 
  </div>
  <div class="ranking-row" id="rankingRow" style="display: none;">
    <!-- 8 drop zones -->
    <div class="ranking-slot" data-rank="1"></div>
    <div class="ranking-slot" data-rank="2"></div>
    <div class="ranking-slot" data-rank="3"></div>
    <div class="ranking-slot" data-rank="4"></div>
    <div class="ranking-slot" data-rank="5"></div>
    <div class="ranking-slot" data-rank="6"></div>
    <div class="ranking-slot" data-rank="7"></div>
    <div class="ranking-slot" data-rank="8"></div>
  </div>

  <div id="cards" style="margin-bottom: 20px; display: none;"></div>


  <div id="snippet-bar" style="display: none; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #f5f5f5; border-radius: 6px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <h3 style="margin: 0; font-size: 16px; color: #333;">
      üîç Snippet Preview & Compare <span style="font-weight: normal;">(click on view checkboxes to preview or compare snippets)</span>
    </h3>
        <button id="theme-toggle" onclick="toggleTheme()" style="padding: 6px 12px; font-size: 14px; border-radius: 5px; background-color: #333; color: white; border: none; cursor: pointer;">
      Switch to Dark Mode
    </button>
  </div>
  
  <div class="preview-area" id="previewArea"></div>

  <div class="content-wrapper">
    <div id="disagreement-box" class="disagreement-box fade">
      <!-- Disagreement content here -->
    </div>
  
    <div class="right-panel">
      <div id="question-box" class="question-box">
        <!-- JS will populate this -->
      </div>
  
      <div class="navigation">
        <button onclick="prev()" id="prevBtn">‚¨ÖÔ∏è Previous</button>
        <button onclick="next()" id="nextBtn">Next ‚û°Ô∏è</button>
      </div>
      <div style="margin-top: 30px;">
        <button id="continueBtn" onclick="goToPhase4()" style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; background-color: gray; color: white; cursor: pointer;">Continue to Phase 4 ‚û°Ô∏è</button>
      </div>
    </div>
  </div>


  <div id="validation-modal" style="
  display: none;
  position: fixed;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #fff0f0;
  color: #660000;
  border: 1px solid #ff9999;
  padding: 20px;
  border-radius: 10px;
  width: 440px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  z-index: 1002;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  ">
    <p id="validation-message" style="font-weight: bold;"></p>
    <button onclick="document.getElementById('validation-modal').style.display = 'none';" style="
      margin-top: 15px;
      padding: 8px 14px;
      background-color: #ff9999;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    ">OK</button>
  </div>

<div id="snippet-modal" style="display:none; position:fixed; top:10%;
left:50%; transform:translateX(-50%); width:80%; max-height:80%;
overflow-y:auto; background:#fff; border:1px solid #ccc; padding:0px 20px;
border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.2); z-index:1002;">
  <div style="position: sticky; top: 0; background: #fff; z-index: 10; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
    <h3 id="modal-snippet-title" style="margin:0;">Snippet</h3>
    <div>
      <button onclick="toggleModalTheme()" id="modal-theme-toggle" style="margin-right: 10px; padding: 6px 12px; border-radius: 5px; border: none; background-color: #333; color: white; cursor: pointer;">Switch to Light Mode</button>
      <span onclick="document.getElementById('snippet-modal').style.display='none'" style="cursor:pointer; font-size:20px; font-weight:bold;">&times;</span>
    </div>
  </div>

  <div class="code-container" id="modal-code">
    <div class="line-numbers" id="modal-line-numbers"></div>
    <div class="code-content" id="modal-code-content"></div>
  </div>
</div>


<div id="compare-modal" style="display:none; position:fixed; top:10%;
left:50%; transform:translateX(-50%); width:90%; max-height:80%;
overflow-y:auto; background:#fff; border:1px solid #ccc;
padding: 0px 20px!important;
border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.2); z-index:1002;">
  <div style="position: sticky; top: 0; background: #fff; display: flex;
  justify-content: space-between; align-items: center; margin-bottom: 15px;
  padding: 10px 0px; z-index: 0; border-bottom: 1px solid #ddd;">
    <h3 style="margin: 0;">Compare Snippets</h3>
    <span onclick="document.getElementById('compare-modal').style.display='none'" style="cursor: pointer; font-size: 20px; font-weight: bold;">&times;</span>
  </div>

  <div id="compare-columns" style="display: flex; gap: 20px; ">
    <div id="compare-left" style="flex: 1; overflow-x: auto;" ></div>
    <div id="compare-right" style="flex: 1; overflow-x: auto;"></div>
  </div>
</div>

<script>
    function firstChars(name, count = 5) {
  if (!name) return "";
  return name.slice(0, count);
}
</script>
<script src="js/rankings_in_round4.js"></script>

<script>
  function showValidationMessage(msg) {
    document.getElementById('validation-message').innerText = msg;
    document.getElementById('validation-modal').style.display = 'block';
  }
</script>

<script>
  const originalSnippets = [
    {
      id: 1,
      title: "isValidProjectName",
      code: `
<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">isValidProjectName</span>(<span class="type">String</span> name) {
    <span class="keyword">if</span> (name == <span class="literal">null</span>) {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">if</span> (name.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#startsWith-java.lang.String-')">startsWith</a>(<span class="string">"."</span>)) {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">if</span> ((name.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#length--')">length</a>() < <span class="number">1</span>) || (name.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#length--')">length</a>() > MAX_NAME_LENGTH)) {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i < name.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#length--')">length</a>(); i++) {
        <span class="type">char</span> c = name.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#charAt-int-')">charAt</a>(i);
        <span class="keyword">if</span> (!Character.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/Character.html#isLetterOrDigit-char-')">isLetterOrDigit</a>(c) && !VALID_NAME_SET.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/util/Set.html#contains-java.lang.Object-')">contains</a>(c)) {
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
}
`
          },
          {
            id: 2,
            title: "isRemote",
            code: `
<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">isRemote</span>(<span class="type">URI</span> uri) {
    <span class="keyword">if</span> (<span class="function">isFilesystemPath</span>(uri)) {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="type">String</span> scheme = uri.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/net/URI.html#getScheme--')">getScheme</a>();
    <span class="keyword">if</span> (scheme == <span class="literal">null</span>) {
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">switch</span> (scheme) {
        <span class="keyword">case</span> <span class="string">"file"</span>:
        <span class="keyword">case</span> <span class="string">"jar"</span>:
            <span class="keyword">return</span> <span class="literal">false</span>;
        <span class="keyword">default</span>:
            <span class="keyword">break</span>;
    }
    <span class="keyword">return</span> <span class="literal">true</span>;
}
`            
          },
          {
            id: 3,
            title: "isMachineTypeDefined",
            code: `
<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">isMachineTypeDefined</span>(<span class="type">short</span> type) {
    <span class="keyword">if</span> (type == IMAGE_FILE_MACHINE_UNKNOWN) {
        <span class="comment">// Unsupported machine type</span>
        <span class="keyword">return</span> <span class="literal">false</span>;
    }
    <span class="keyword">for</span> (<span class="type">Field</span> field : CoffMachineType.<span class="function">class</span>.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getDeclaredFields--')">getDeclaredFields</a>()) {
        <span class="keyword">if</span> (!field.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Field.html#isSynthetic--')">isSynthetic</a>()) {
            <span class="type">int</span> modifiers = field.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Field.html#getModifiers--')">getModifiers</a>();
            <span class="keyword">if</span> (<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Modifier.html#isFinal-int-')">Modifier.isFinal</a>(modifiers) && <a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Modifier.html#isStatic-int-')">Modifier.isStatic</a>(modifiers)) {
                <span class="keyword">try</span> {
                    <span class="keyword">if</span> (field.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Field.html#getShort-java.lang.Object-')">getShort</a>(<span class="literal">null</span>) == type) {
                        <span class="keyword">return</span> <span class="literal">true</span>;
                    }
                } <span class="keyword">catch</span> (<span class="type">IllegalAccessException</span> e) {
                    <span class="keyword">continue</span>;
                }
            }
        }
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
}
`            
          },
          {
            id: 4,
            title: "indexOfIgnoreCase",
code: `<span class="keyword">public static</span> <span class="type">int</span> <span class="function">indexOfIgnoreCase</span>(<span class="type">CharSequence</span> str, <span class="type">CharSequence</span> searchStr, <span class="type">int</span> startPos) {
    <span class="keyword">if</span> (str == <span class="literal">null</span> || searchStr == <span class="literal">null</span>) {
        <span class="keyword">return</span> INDEX_NOT_FOUND;
    }
    <span class="keyword">if</span> (startPos < <span class="number">0</span>) {
        startPos = <span class="number">0</span>;
    }
    <span class="type">int</span> searchStrLen = searchStr.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#length--')">length</a>();
    <span class="type">int</span> endLimit = str.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#length--')">length</a>() - searchStrLen + <span class="number">1</span>;
    <span class="keyword">if</span> (startPos > endLimit) {
        <span class="keyword">return</span> INDEX_NOT_FOUND;
    }
    <span class="keyword">if</span> (searchStrLen == <span class="number">0</span>) {
        <span class="keyword">return</span> startPos;
    }
    <span class="keyword">for</span> (<span class="type">int</span> i = startPos; i < endLimit; i++) {
        <span class="keyword">if</span> (<span class="function">regionMatches</span>(str, <span class="literal">true</span>, i, searchStr, <span class="number">0</span>, searchStrLen)) {
            <span class="keyword">return</span> i;
        }
    }
    <span class="keyword">return</span> INDEX_NOT_FOUND;
}`
          },              
          {
            id: 5,
            title: "deleteRecursively",
            code: `
<span class="keyword">public static</span> <span class="type">boolean</span> <span class="function">deleteRecursively</span>(@Nullable <span class="type">Path</span> root) <span class="keyword">throws</span> <span class="type">IOException</span> {
    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;
    <span class="keyword">if</span> (!<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#exists-java.nio.file.Path-java.nio.file.LinkOption...-')">Files.exists</a>(root)) <span class="keyword">return</span> <span class="literal">false</span>;

    <a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#walkFileTree-java.nio.file.Path-java.nio.file.FileVisitor-')">Files.walkFileTree</a>(root, <span class="keyword">new</span> <span class="type">SimpleFileVisitor</span>&lt;&gt;() {
        @Override
        <span class="keyword">public</span> <span class="type">FileVisitResult</span> <span class="function">visitFile</span>(<span class="type">Path</span> file, <span class="type">BasicFileAttributes</span> attrs) <span class="keyword">throws</span> <span class="type">IOException</span> {
            <a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#delete-java.nio.file.Path-')">Files.delete</a>(file);
            <span class="keyword">return</span> FileVisitResult.CONTINUE;
        }
        @Override
        <span class="keyword">public</span> <span class="type">FileVisitResult</span> <span class="function">postVisitDirectory</span>(<span class="type">Path</span> dir, <span class="type">IOException</span> exc) <span class="keyword">throws</span> <span class="type">IOException</span> {
            <a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html#delete-java.nio.file.Path-')">Files.delete</a>(dir);
            <span class="keyword">return</span> FileVisitResult.CONTINUE;
        }
    });

    <span class="keyword">return</span> <span class="literal">true</span>;
}
`            
      },
      {
        id: 6,
        title: "encodedLength",
        code: `
<span class="keyword">public static</span> <span class="type">int</span> <span class="function">encodedLength</span>(<span class="type">CharSequence</span> sequence) {
    <span class="comment">// Optimized implementation</span>
    <span class="type">int</span> utf16Length = sequence.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#length--')">length</a>();
    <span class="type">int</span> utf8Length = utf16Length;
    <span class="type">int</span> i = <span class="number">0</span>;

    <span class="keyword">while</span> (i < utf16Length && sequence.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#charAt-int-')">charAt</a>(i) < <span class="literal">0x80</span>) {
        i++;
    }

    <span class="keyword">for</span> (; i < utf16Length; i++) {
        <span class="type">char</span> c = sequence.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/CharSequence.html#charAt-int-')">charAt</a>(i);
        <span class="keyword">if</span> (c < <span class="literal">0x800</span>) {
            utf8Length += ((<span class="literal">0x7f</span> - c) >>> <span class="number">31</span>);
        } <span class="keyword">else</span> {
            utf8Length += <span class="function">encodedLengthGeneral</span>(sequence, i);
            <span class="keyword">break</span>;
        }
    }

    <span class="keyword">if</span> (utf8Length < utf16Length) {
        <span class="keyword">throw new</span> <span class="type">IllegalArgumentException</span>(
            <span class="string">"UTF-8 length does not fit in int: "</span> + (utf8Length + (<span class="literal">1L</span> << <span class="number">32</span>)));
    }

    <span class="keyword">return</span> utf8Length;
}
`        
      },
      {
        id: 7,
        title: "lowestPositiveRoot",
        code: `
<span class="keyword">public static</span> <span class="type">float</span> <span class="function">lowestPositiveRoot</span>(<span class="type">float</span> a, <span class="type">float</span> b, <span class="type">float</span> c) {
    <span class="type">float</span> det = b * b - <span class="number">4</span> * a * c;
    <span class="keyword">if</span> (det < <span class="number">0</span>) <span class="keyword">return</span> <span class="type">Float</span>.NaN;

    <span class="type">float</span> sqrtD = (<span class="type">float</span>)<span class="type">Math</span>.<a href="#" class="standard-method function" onclick="openJavadocModal('https://docs.oracle.com/javase/8/docs/api/java/lang/Math.html#sqrt-double-')">sqrt</a>(det);
    <span class="type">float</span> invA = <span class="number">1</span> / (<span class="number">2</span> * a);
    <span class="type">float</span> r1 = (-b - sqrtD) * invA;
    <span class="type">float</span> r2 = (-b + sqrtD) * invA;

    <span class="keyword">if</span> (r1 > r2) {
        <span class="type">float</span> tmp = r2;
        r2 = r1;
        r1 = tmp;
    }

    <span class="keyword">if</span> (r1 > <span class="number">0</span>) <span class="keyword">return</span> r1;
    <span class="keyword">if</span> (r2 > <span class="number">0</span>) <span class="keyword">return</span> r2;
    <span class="keyword">return</span> <span class="type">Float</span>.NaN;
}
`        
      },
      {
        id: 8,
        title: "atan2",
        code: `
<span class="keyword">public static</span> <span class="type">float</span> <span class="function">atan2</span>(<span class="type">float</span> y, <span class="type">float</span> x) {
    <span class="type">float</span> n = y / x;

    <span class="keyword">if</span> (n != n)
        n = (y == x ? <span class="number">1f</span> : <span class="number">-1f</span>);
    <span class="keyword">else if</span> (n - n != n - n)
        x = <span class="number">0f</span>;

    <span class="keyword">if</span> (x > <span class="number">0</span>)
        <span class="keyword">return</span> <span class="function">atanUnchecked</span>(n);
    <span class="keyword">else if</span> (x < <span class="number">0</span>) {
        <span class="keyword">if</span> (y >= <span class="number">0</span>) <span class="keyword">return</span> <span class="function">atanUnchecked</span>(n) + PI;
        <span class="keyword">return</span> <span class="function">atanUnchecked</span>(n) - PI;
    } <span class="keyword">else if</span> (y > <span class="number">0</span>)
        <span class="keyword">return</span> x + HALF_PI;
    <span class="keyword">else if</span> (y < <span class="number">0</span>)
        <span class="keyword">return</span> x - HALF_PI;

    <span class="keyword">return</span> x + y;
}
`        
      }
    ];
  

  function getStoredSnippetOrder() {
    const stored = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder');
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed) && parsed.length === 8) return parsed;
      } catch {}
    }
    return null;
  }

  // Apply the stored snippet order
  const order = getStoredSnippetOrder();
  const snippets = [];

  if (order) {
    order.forEach((index, newId) => {
      snippet = { ...originalSnippets[index - 1] }; 
      snippet.id = newId + 1;
      snippet.title = `Snippet ${newId + 1}`;
      snippets.push(snippet);
    });
  } else {
    alert("‚ö†Ô∏è Missing snippet order. Please login again.");
    window.location.href = '/';
  }

  console.log("Applied snippet order:", snippets.map(s => s.title));

</script>
<script>
  window.onload = () => {
      remapSnippetReferences(participantRankings);
      renderParticipantRankings();
      render();
      attachAutosaveListeners();
      loadCards();
      loadState();
      applyTheme();
      displayUserName();

    const continueBtn = document.getElementById('continueBtn');
    if (sessionStorage.getItem('round4-phase3-complete') === 'true' || localStorage.getItem('round4-phase2-complete') === 'true') {
      if (continueBtn) {
        continueBtn.style.display = 'inline-block';
        continueBtn.style.backgroundColor = '#4CAF50';
        continueBtn.style.animation = 'glowPulse 1.5s infinite alternate';
      }
    }

    // Unlock and highlight status bar
    if (isComplete('round4-phase1-complete')) document.getElementById('link-phase2').classList.remove('disabled');
    if (isComplete('round4-phase2-complete')) document.getElementById('link-phase3').classList.remove('disabled');
    if (isComplete('round4-phase3-complete')) document.getElementById('link-phase4').classList.remove('disabled');
    if (isComplete('round4-phase4-complete')) document.getElementById('link-phase5').classList.remove('disabled');
    if (isComplete('round4-phase5-complete')) document.getElementById('link-review').classList.remove('disabled');

    const current = window.location.pathname.split('/').pop();
    if (current.includes('phase1')) document.getElementById('link-phase1').classList.add('active');
    else if (current.includes('phase2')) document.getElementById('link-phase2').classList.add('active');
    else if (current.includes('phase3')) document.getElementById('link-phase3').classList.add('active');
    else if (current.includes('phase4')) document.getElementById('link-phase4').classList.add('active');
    else if (current.includes('phase5')) document.getElementById('link-phase5').classList.add('active');
    else if (current.includes('review')) document.getElementById('link-review').classList.add('active');

    if (sessionStorage.getItem('round4-phase3-complete') === 'true' || localStorage.getItem('round4-phase3-complete') === 'true') {
      document.getElementById('continueBtn').style.display = 'inline-block';
      document.getElementById('continueBtn').style.backgroundColor = '#4CAF50';
      document.getElementById('continueBtn').style.animation = 'glowPulse 1.5s infinite alternate';
    }

    setInterval(() => {
      try {
        saveToServer();
        console.log("[Auto-Save] Progress saved to server.");
      } catch (e) {
        console.warn("[Auto-Save] Failed to save:", e);
      }
    }, 120000); // every 2 minutes
  };

  function loadCards() {
    const container = document.getElementById('cards');
    snippets.forEach(snippet => {
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = true;
      card.id = `snippet-${snippet.id}`;
      card.innerHTML = `
          <strong>${snippet.title}</strong>
          <br><label><input type="checkbox" onchange="togglePreview(${snippet.id}, this)"> View</label>
        `;
      card.addEventListener('dragstart', () => card.classList.add('dragging'));
      card.addEventListener('dragend', () => card.classList.remove('dragging'));
      container.appendChild(card);
    });

    document.querySelectorAll('.ranking-slot').forEach(slot => {
      slot.addEventListener('dragover', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        if (dragging) slot.appendChild(dragging);
        saveState();
      });
    });
  }

  function togglePreview(id, checkbox) {
    const previewArea = document.getElementById('previewArea');
    const snippet = snippets.find(s => s.id === id);
    const existing = document.getElementById(`preview-${id}`);

    if (checkbox.checked && !existing) {
      const wrapper = document.createElement('div');
      wrapper.id = `preview-${id}`;
      wrapper.className = 'snippet-preview-box';

      const header = document.createElement('div');
      header.className = 'snippet-header';
      header.textContent = snippet.title;

      const codeBox = document.createElement('div');
      codeBox.className = 'code-box';
      codeBox.innerHTML = snippet.code;

      wrapper.appendChild(header);
      wrapper.appendChild(codeBox);
      previewArea.appendChild(wrapper);
    } else if (!checkbox.checked && existing) {
      previewArea.removeChild(existing);
    }
  }

  function saveState() {
    const positions = {};
    document.querySelectorAll('.ranking-slot').forEach((slot, index) => {
      positions[index + 1] = Array.from(slot.children).map(el => el.id);
    });
    const json = JSON.stringify(positions);
    sessionStorage.setItem('phase3_ranking', json);
    document.cookie = `phase3_ranking=${encodeURIComponent(json)}; path=/; max-age=${60 * 60 * 24 * 30}`;

    /* Check if the phase is completed */
    if (areAllDisagreementsAnswered()) {
      console.log("areAllDisagreementsAnswered4");
      document.getElementById('continueBtn').style.display = 'inline-block';
      document.getElementById('continueBtn').style.backgroundColor = '#4CAF50';
      document.getElementById('continueBtn').style.animation = 'glowPulse 1.5s infinite alternate';
      sessionStorage.setItem('round4-phase2-complete', 'true');
      document.cookie = `round4-phase2-complete=true; path=/; max-age=${60 * 60 * 24 * 30}`;

      // ‚úÖ Also update the status bar
      const phase4Link = document.getElementById('link-phase4');
      if (phase4Link) {
        phase4Link.classList.remove('disabled');
      }
    } else {
      sessionStorage.removeItem('phase2Complete');
      document.cookie = `phase2Complete=; path=/; max-age=0`;
      document.getElementById('continueBtn').style.display = 'none';
      const phase4Link = document.getElementById('link-phase4');
      if (phase4Link) {
        phase4Link.classList.add('disabled');
      }
    }

  }

  function loadState() {
    let saved = sessionStorage.getItem('phase3_ranking') || localStorage.getItem('phase3_ranking');


    if (!saved) return;

    try {
      const parsed = JSON.parse(saved);  // now valid JSON
      Object.entries(parsed).forEach(([rank, ids]) => {
        const slot = document.querySelector(`.ranking-slot[data-rank='${rank}']`);
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el && slot) slot.appendChild(el);
        });
      });
    } catch (e) {
      console.error('Failed to parse phase3_ranking JSON:', e);
    }
  }


  function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.contains('dark-mode');

    if (isDark) {
      body.classList.remove('dark-mode');
      localStorage.setItem('codeTheme', 'light');
      document.getElementById('theme-toggle').textContent = 'Switch to Dark Mode';
    } else {
      body.classList.add('dark-mode');
      localStorage.setItem('codeTheme', 'dark');
      document.getElementById('theme-toggle').textContent = 'Switch to Light Mode';
    }
  }

  function applyTheme() {
    const theme = localStorage.getItem('codeTheme') || 'light';
    const btn = document.getElementById('theme-toggle');

    if (theme === 'dark') {
      document.body.classList.add('dark-mode');
      if (btn) btn.textContent = 'Switch to Light Mode';
    } else {
      document.body.classList.remove('dark-mode');
      if (btn) btn.textContent = 'Switch to Dark Mode';
    }
  }

  function goToPhase4() {
    next();
    if (areAllDisagreementsAnswered()) {
      location.href = '/round4-phase4.html';
    } else { showValidationMessage("‚ö†Ô∏è Please answer all questions") };
  }

  /*For the instructions section*/
  function toggleInstructions() {
    const content = document.getElementById("instructions-content");
    const button = event.target;

    if (content.style.display === "none") {
      content.style.display = "block";
      button.textContent = "Hide";
    } else {
      content.style.display = "none";
      button.textContent = "Show";
    }
  }

  function getLocalStorage(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  }

  function isComplete(key) {
    return sessionStorage.getItem(key) === 'true' || localStorage.getItem(key) === 'true';
  }

  function areAllCardsRanked() {
    const allCards = document.querySelectorAll('.card');
    const assignedCardIds = new Set();

    document.querySelectorAll('.ranking-slot').forEach(slot => {
      slot.querySelectorAll('.card').forEach(card => {
        assignedCardIds.add(card.id);
      });
    });

    return allCards.length === assignedCardIds.size;
  }


</script>

<script>
  function displayUserName() {
    const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName');
    if (name) {
      document.getElementById('user-info').textContent = `üë§ ${name}`;
    }
  }
</script>

<script>
  function isLoggedIn() {
    const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName');
    const order = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder');
    return name && order;
  }

  function checkLogin() {
    if (!isLoggedIn()) {
      alert('You must be logged in to access this page. Redirecting to the homepage.');
      window.location.href = '/';
    }
  }

  function checkPhase1Completion() {
    if (!isPhaseComplete('round4-phase1-complete')) {
      alert('Please complete Phase 1 before continuing.');
      window.location.href = 'round4-phase1.html';
    }
  }

  function isPhaseComplete(phaseKey) {
    const sessionVal = sessionStorage.getItem(phaseKey);
    const cookieVal = localStorage.getItem(phaseKey);
    return sessionVal === 'true' || cookieVal === 'true';
  }

  window.addEventListener('load', checkLogin);
  window.addEventListener('load', checkPhase1Completion);
</script>


<script>
  // Toggle logout menu visibility
  // document.addEventListener('DOMContentLoaded', () => {
  //   const userInfo = document.getElementById('user-info');
  //   const logoutMenu = document.getElementById('logout-menu');

  //   userInfo.addEventListener('click', () => {
  //     logoutMenu.style.display = logoutMenu.style.display === 'block' ? 'none' : 'block';
  //   });

  //   // Hide the menu if clicked outside
  //   document.addEventListener('click', (event) => {
  //     if (!event.target.closest('.user-dropdown')) {
  //       logoutMenu.style.display = 'none';
  //     }
  //   });
  // });

  // Clear storage and redirect to login
  function logout() {
    sessionStorage.clear();
    localStorage.clear();


    // Clear all cookies
    document.cookie.split(";").forEach(cookie => {
      const name = cookie.split("=")[0].trim();
      document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
    });

    window.location.href = 'round4.html';
  }
</script>

<script>
async function saveToServer() {
  const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName') || 'Anonymous';
  const username = localStorage.getItem('username') || 'anonymous';

  // Phase 1 data
  const phase1 = {};
  for (let i = 1; i <= 8; i++) {
    const summary = sessionStorage.getItem(`summary${i}`) || localStorage.getItem(`summary${i}`) || '';
    const comp = sessionStorage.getItem(`compSummary${i}`) || localStorage.getItem(`compSummary${i}`) || '';
    phase1[`snippet${i}`] = { summary, comprehensibility: comp };
  }

  // Phase 2 & 3 data
  let phase2 = {}, phase3 = {};
  try {
    phase2 = JSON.parse(sessionStorage.getItem('phase3_ranking') || localStorage.getItem('phase3_ranking') || '{}');
    phase3 = JSON.parse(sessionStorage.getItem('phase3_reasoning') || localStorage.getItem('phase3_reasoning') || '{}');
  } catch (e) {
    console.warn("‚ö†Ô∏è Error parsing phase2 or phase3 data", e);
  }

  // Round 2 responses
  const round4Responses = {};
  for (let i = 0; i <= 4; i++) {
    const key = `round4_response_${i}`;
    const val = localStorage.getItem(key) || sessionStorage.getItem(key);
    if (val) {
      try {
        round4Responses[key] = JSON.parse(val);
      } catch (e) {
        round4Responses[key] = val;
      }
    }
  }

  // Completion flags
  const phaseCompletion = {};
  for (let i = 1; i <= 5; i++) {
    const key = `round4-phase${i}-complete`;
    phaseCompletion[key] = sessionStorage.getItem(key) || localStorage.getItem(key) || 'false';
  }

  // Other flags
  const flags = {
    codeTheme: localStorage.getItem('codeTheme') || 'light',
    submitted: '0',
    studyRound: '2'
  };

  // Final payload
  const payload = {
    username,
    participantName: name,
    phase1,
    phase2,
    phase3,
    ...round4Responses,
    ...phaseCompletion,
    ...flags
  };

  const payloadStr = JSON.stringify(payload);

  // Hash function
  async function hashString(str) {
    const buffer = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest('SHA-256', buffer);
    return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, '0')).join('');
  }

  const currentHash = await hashString(payloadStr);
  const previousHash = sessionStorage.getItem('lastPayloadHash_round4');

  if (currentHash === previousHash) {
    console.log('üü° Payload unchanged, not sending to server.');
    return;
  }

  sessionStorage.setItem('lastPayloadHash_round4', currentHash);

  const blob = new Blob([payloadStr], { type: 'application/json' });
  navigator.sendBeacon('/submit_round4', blob);

  console.log('‚úÖ Round 2 payload sent to server:', payload);
}


  window.addEventListener('beforeunload', function (e) {
    saveToServer();
  });


</script>

<script>
  function remapSnippetReferences(rankings) {
    console.log('sessionStorage:', sessionStorage.getItem('snippetOrder'));
    console.log('cookie:', document.cookie);

    if (!Array.isArray(rankings)) {
      console.error('remapSnippetReferences: rankings is not a valid array.');
      return;
    }

    // Step 1: Get snippet order from sessionStorage, localStorage, or cookie
    function getSnippetOrder() {
      const key = 'snippetOrder';
      const sessionValue = sessionStorage.getItem(key) || localStorage.getItem(key);
      if (sessionValue) return JSON.parse(sessionValue);

      const cookieMatch = document.cookie
              .split('; ')
              .find(row => row.startsWith(key + '='));
      if (cookieMatch) {
        const cookieValue = decodeURIComponent(cookieMatch.split('=')[1]);
        return JSON.parse(cookieValue);
      }
      return [];
    }

    const snippetOrder = getSnippetOrder();
    if (!Array.isArray(snippetOrder) || snippetOrder.length !== 8) {
      console.warn('Invalid or missing snippetOrder:', snippetOrder);
      return;
    }

    // Step 2: Build reverse mapping: original snippet number ‚Üí local snippet number
    const map = {};
    for (let i = 0; i < 8; i++) {
      map[snippetOrder[i]] = i + 1;
    }

    // Step 3: Remap snippet references in participant HTML
    rankings.forEach(participant => {
      let updated = participant.html;

      // ‚úÖ Replace "Snippet X" or "snippet X" in visible text, preserving casing
      updated = updated.replace(/\bsnippet (\d)\b/gi, (_, num, offset, str) => {
        const mapped = map[parseInt(num)];
        const originalWord = str.slice(offset, offset + 7); // 'Snippet' or 'snippet'
        const capitalized = originalWord[0] === 'S';
        return `${capitalized ? 'Snippet' : 'snippet'} ${mapped}`;
      });

      // ‚úÖ Replace class="snippet-X"
      updated = updated.replace(/class="snippet-(\d)"/g, (_, num) => {
        const mapped = map[parseInt(num)];
        return `class="snippet-${mapped}"`;
      });

      // ‚úÖ Replace show_snippet(X)
      updated = updated.replace(/show_snippet\((\d)\)/g, (_, num) => {
        const mapped = map[parseInt(num)];
        return `show_snippet(${mapped})`;
      });

      // ‚úÖ Replace compare([X,...],[Y,...])
      updated = updated.replace(/compare\(\[([^\]]*)\],\s*\[([^\]]*)\]\)/g, (_, group1, group2) => {
        const mapGroup = g =>
                g.split(',')
                        .map(x => {
                          const trimmed = x.trim();
                          return trimmed ? map[parseInt(trimmed)] : '';
                        })
                        .filter(x => x !== '')
                        .join(',');
        return `compare([${mapGroup(group1)}], [${mapGroup(group2)}])`;
      });

      // Final result
      participant.html = updated;
    });
  }


function renderParticipantRankings() {
  const container = document.querySelector('.phase-section');
  if (!container) {
    console.error('No .phase-section container found.');
    return;
  }

  container.innerHTML = ''; // Clear existing content

  const currentUser = (sessionStorage.getItem('username') || localStorage.getItem('username') || '').trim().toLowerCase();

  let yourHTML = '';
  const others = [];

  participantRankings.forEach(participant => {
    const participantName = participant.name.trim();
    const isCurrentUser = participantName.toLowerCase() === currentUser;

    const updatedHTML = participant.html.replace(
      new RegExp(`<h3>${participantName}</h3>`),
      `<h3>${isCurrentUser ? 'Your Ranking' : participantName}</h3>`
    );

    if (isCurrentUser) {
      yourHTML = updatedHTML;
    } else {
      others.push(updatedHTML);
    }
  });

  // Append your ranking first
  if (yourHTML) {
    const yourWrapper = document.createElement('div');
    yourWrapper.innerHTML = yourHTML;
    container.appendChild(yourWrapper);
  }

  // Append others
  others.forEach(html => {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    container.appendChild(wrapper);
  });
}


</script>

<script>
      function show_snippet(id) {
        // id=id-1;
    const snippet = snippets.find(s => s.id === id);
    if (!snippet) return;

    document.getElementById('modal-snippet-title').innerText = snippet.title;

    const codeLines = snippet.code.trim().split('\n');

    // ‚úÖ Use innerHTML here to render styled spans correctly
    document.getElementById('modal-code-content').innerHTML = codeLines.join('\n');

    // ‚úÖ Line numbers are just plain numbers
    document.getElementById('modal-line-numbers').innerHTML = codeLines.map((_, i) => i + 1).join('<br>');

    document.getElementById('snippet-modal').style.display = 'block';

    applyModalTheme(); // Keep the theme consistent
    }

    
    function toggleModalTheme() {
      const body = document.body;
      const isLight = body.classList.contains("light-mode");
    
      if (isLight) {
        body.classList.remove("light-mode");
        body.classList.add("dark-mode");
        localStorage.setItem("codeTheme", "dark");
        document.getElementById('modal-theme-toggle').textContent = "Switch to Light Mode";
      } else {
        body.classList.remove("dark-mode");
        body.classList.add("light-mode");
        localStorage.setItem("codeTheme", "light");
        document.getElementById('modal-theme-toggle').textContent = "Switch to Dark Mode";
      }
    }
    
    function applyModalTheme() {
      const theme = localStorage.getItem('codeTheme') || 'light';
      document.body.classList.remove('light-mode', 'dark-mode');
      document.body.classList.add(theme + '-mode');
      document.getElementById('modal-theme-toggle').textContent =
        theme === 'light' ? "Switch to Dark Mode" : "Switch to Light Mode";
    }


</script>

<script>
      function compare(leftIds, rightIds) {
  const leftContainer = document.getElementById('compare-left');
  const rightContainer = document.getElementById('compare-right');
  leftContainer.innerHTML = '';
  rightContainer.innerHTML = '';

  const getSnippet = id => snippets.find(s => s.id === id);

  // Left side: stacked
  leftIds.forEach(id => {
    const snippet = getSnippet(id);
    if (snippet) {
      const box = document.createElement('div');
      box.className = 'snippet-box';
      box.innerHTML = `<h4>${snippet.title}</h4><pre class="code-content">${snippet.code}</pre>`;
      leftContainer.appendChild(box);
    }
  });

  // Right side: stacked
  rightIds.forEach(id => {
    const snippet = getSnippet(id);
    if (snippet) {
      const box = document.createElement('div');
      box.className = 'snippet-box';
      box.innerHTML = `<h4>${snippet.title}</h4><pre class="code-content">${snippet.code}</pre>`;
      rightContainer.appendChild(box);
    }
  });

  document.getElementById('compare-modal').style.display = 'block';
}
</script>

 <script>
const disagreements = [
  {
    snippet: "isValidProjectName",
    text: "isValidProjectName shows noticeable disagreement across experts, with most placing it in the easiest tier and others rating it slightly or significantly harder.\n<br>*Experts A, B, and E all ranked isValidProjectName in Position 1.\n<br>‚Äì Expert A described it as ‚Äúsimple to understand‚Äù with ‚Äúvery clear‚Äù method and variable names. They emphasized that short, self-contained methods like this have an obvious purpose and that ‚Äúthe purpose of local variables and called methods is clear,‚Äù which makes it belong among the easiest code.\n<br>‚Äì Expert B also viewed it as one of the simplest methods, praising its well-structured conditions and noting that each check contributes independently to the overall validation. In comparing it to isRemote, they said that ‚Äúthe problem of defining a valid project name is more straightforward than that of defining a URI as local‚Äù and that the project-name validator is ‚Äúvery self explanatory,‚Äù reinforcing why they consider it strictly easier.\n<br>‚Äì Expert E likewise considered it very easy, saying that the method signature and the simple sequence of checks made it ‚Äúpretty easy to understand.‚Äù They highlighted that ‚Äúeverything isValidProjectName does is right there in front of you and self-contained,‚Äù unlike isRemote, which relies on domain knowledge about URI schemes and an unseen helper.\n<br>\n<br>*Expert C ranked isValidProjectName slightly harder, in Position 2.\n<br>‚Äì They found it mostly easy to follow but were unsure why both a letter-or-digit check and a separate valid-character-set check were necessary. They explained that isValidProjectName (and isRemote) requires a bit more domain knowledge to understand the special cases, whereas their easiest methods‚ÄîindexOfIgnoreCase and deleteRecursively‚Äîcan be followed line by line without additional assumptions.\n<br>\n<br>*Expert D placed isValidProjectName much higher, at Position 4.\n<br>‚Äì They wrote that the method is understandable, but that the initial chain of validations is too long and could be ‚Äúsummarized a little without losing the readability.‚Äù They consistently favored code whose naming and structure felt more compact and directly aligned with its purpose, which pushed isValidProjectName outside the easiest tier for them.\n<br>\n<br>Overall, the disagreement arises from how experts weigh the method's length, redundancy of checks, and the small amount of domain knowledge it assumes. For some, these details are negligible, leaving the method firmly among the easiest; for others, they introduce enough overhead to move it into a slightly or significantly harder tier."
  },

  {
    snippet: "isRemote",
    text: "isRemote shows disagreement relative to mid-range snippets, even though most experts view it as generally clear.\n<br>*Experts A and D placed isRemote in Position 1.\n<br>‚Äì Expert A called it ‚Äúconcise,‚Äù with explicit and simple method names and ‚Äúoverall, good comprehensibility.‚Äù They emphasized that short, self-contained methods like this do not require extensive background knowledge.\n<br>‚Äì Expert D similarly described the method as ‚Äúclear and easy to read in its operation,‚Äù noting that it has good structure and intuitive flow.\n<br>\n<br>*Experts B, C, and E placed isRemote in Position 2.\n<br>‚Äì Expert E still found it ‚Äúpretty straightforward,‚Äù praising the switch statement for organizing the cases clearly. However, when contrasting it with isValidProjectName, they said that isRemote requires reasoning about URI schemes and about the behavior of isFilesystemPath(uri), which is not shown.\n<br>‚Äì Expert B said isRemote is ‚Äúnot bad‚Äù but ‚Äúnot perfect either,‚Äù explaining that defining a URI as local vs remote is inherently less straightforward than validating a project name. They also noted that URI is ‚Äúone of those classes you don‚Äôt use every day,‚Äù often requiring documentation.\n<br>‚Äì Expert C questioned why schemes like 'file' and 'jar' were treated as special cases and said understanding these rules ‚Äúrequires more knowledge of the domain.‚Äù They contrasted this with indexOfIgnoreCase and deleteRecursively, which they viewed as line-by-line understandable without domain assumptions.\n<br>\n<br>Overall, these differences reveal a split between experts who see isRemote as very easy and those who believe the method demands additional domain or library knowledge‚Äîspecifically understanding URI schemes and helper behavior‚Äîwhich elevates its difficulty slightly above the simplest methods."
  },

  {
    snippet: "isMachineTypeDefined",
    text: "isMachineTypeDefined is one of the most divisive methods, with experts placing it anywhere from near-easy to the hardest in the set.\n<br>*Expert D placed isMachineTypeDefined toward the easy side at Position 2.\n<br>‚Äì They described it as ‚Äúclear, concise,‚Äù praising how reflection is used in a straightforward way to iterate over constants and check for a match. Even though reflection requires some prior knowledge, they felt the intent remained easy to follow.\n<br>\n<br>*Expert C placed it in Position 3.\n<br>‚Äì They said the control flow is understandable but expressed uncertainty about what each field represents and what ‚ÄúisSynthetic‚Äù is doing. They noted that the method ‚Äúrequires business knowledge about the domain,‚Äù and that using reflection to inspect declared fields is ‚Äúadvanced Java stuff that is not very common.‚Äù\n<br>\n<br>*Expert A placed it in Position 4.\n<br>‚Äì They wrote that the method is ‚Äúsimple to comprehend for someone familiar with reflection‚Äù but still requires specific API knowledge. They viewed it similarly to deleteRecursively in terms of difficulty and noted that both methods require more contextual knowledge than the simplest ones like isValidProjectName.\n<br>\n<br>*Expert E placed it significantly harder, at Position 6.\n<br>‚Äì They explained that although the reflective loop is recognizable once you see that it's iterating over constants, the method still relies on understanding modifiers, synthetic vs non-synthetic fields, and why reflection is being used at all. They consistently judged it harder than more linear, mathematical methods like lowestPositiveRoot.\n<br>\n<br>*Expert B placed isMachineTypeDefined at the extreme hard end (Position 8).\n<br>‚Äì They called it ‚Äúdifficult to comprehend,‚Äù arguing that the name implies a general MachineType check, yet the implementation is tied specifically to CoffMachineType. They also noted that one path always triggers a null-pointer exception. They grouped it with encodedLength and atan2 as ‚Äúhacky or cryptic‚Äù functions full of hidden assumptions and errors requiring significant ‚Äúmental debugging.‚Äù\n<br>\n<br>Overall, experts disagreed sharply depending on how comfortable they are with reflection, how much domain context they inferred or expected, and how they assessed the clarity and intention behind the method‚Äôs structure."
  },

  {
    snippet: "indexOfIgnoreCase",
    text: "indexOfIgnoreCase shows varied difficulty assessments, with experts split between viewing it as one of the easiest methods and placing it solidly in the mid-range.\n<br>*Expert C placed indexOfIgnoreCase in Position 1.\n<br>‚Äì They said it ‚Äúflowed very naturally,‚Äù with each condition playing an obvious role in the search logic. They grouped it with deleteRecursively, explaining that both methods can be followed line by line, with meaningful variable names and straightforward logic.\n<br>\n<br>*Experts E and D placed indexOfIgnoreCase in Position 3.\n<br>‚Äì Expert E emphasized that the method's control flow is clear and the earlier return checks are intuitive. They also contrasted it with more complicated methods such as reflection-based ones or UTF-8 encoding, noting that indexOfIgnoreCase is fully self-contained.\n<br>‚Äì Expert D also described it as structurally clear and readable, though more complex than the very simplest methods.\n<br>\n<br>*Experts A and B placed it at Position 5.\n<br>‚Äì Expert A acknowledged that the implementation is generally expected but pointed out naming issues (e.g., ‚Äústr,‚Äù ‚ÄúendLimit‚Äù), saying these reduce readability. They felt this pushes the method slightly harder than some reflection-based ones because the naming obscures intent.\n<br>‚Äì Expert B called the method ‚Äúok‚Äù but noted that the number of intermediate values and the hand-rolled search logic makes it less transparent than shorter, simpler methods. They said deleteRecursively is easier to follow once one ignores its misleading name, and they argued that lowestPositiveRoot can be easier than indexOfIgnoreCase because the latter is ‚Äúreinventing the wheel‚Äù instead of using built-in substring operations.\n<br>\n<br>Overall, indexOfIgnoreCase is a clear point of disagreement about what counts as truly easy code: some see it as a straightforward implementation of string search, while others find its naming, intermediate variables, and reinvention of built-in functionality enough to place it in a more effortful mid-range tier."
  },

  {
    snippet: "lowestPositiveRoot",
    text: "lowestPositiveRoot shows disagreement about how much mathematical familiarity should influence perceived difficulty.\n<br>*Expert B placed lowestPositiveRoot in Position 4.\n<br>‚Äì They described the method as ‚Äúalright,‚Äù explaining that implementing a well-known quadratic formula makes it easier to follow than methods like indexOfIgnoreCase. Although variable names like ‚Äúdet‚Äù and ‚Äúinv‚Äù are not ideal, the mathematical structure is familiar.\n<br>\n<br>*Expert E placed it in Position 5.\n<br>‚Äì They noted that once you recognize the flow as a direct translation of how one solves a quadratic equation by hand, the logic becomes easy to track. Still, they acknowledged it requires some mathematical background. They contrasted it with reflection-heavy methods, saying lowestPositiveRoot has a linear and self-contained structure.\n<br>\n<br>*Experts A, C, and D all placed lowestPositiveRoot at Position 7.\n<br>‚Äì Expert A wrote ‚ÄúNot good,‚Äù highlighting that it requires previous knowledge of the quadratic formula and that abbreviated names like ‚Äúdet,‚Äù ‚ÄúsqrtD,‚Äù ‚ÄúinvA,‚Äù ‚Äúr1,‚Äù and ‚Äúr2‚Äù provide no clarity to someone unfamiliar with the math involved.\n<br>‚Äì Expert C said they were ‚Äúnot familiar enough‚Äù with the abbreviations and felt uncertain about the purpose of swapping the roots. They compared it unfavorably to encodedLength, saying lowestPositiveRoot involves ‚Äúeven more complicated math.‚Äù\n<br>‚Äì Expert D similarly argued that the unclear variable names and reliance on unannotated mathematical steps make the method ‚Äúquite difficult to understand,‚Äù even though the underlying idea is just the quadratic formula.\n<br>\n<br>Overall, lowestPositiveRoot ranges from moderately complex to one of the hardest methods, depending on the expert's mathematical comfort level, expectations about naming clarity, and tolerance for compact representations of formulas."
  },

  {
    snippet: "atan2",
    text: "atan2 is part of the most contested hardest cluster, with experts sharply divided on its difficulty.\n<br>*Experts A and B placed atan2 in Position 8.\n<br>‚Äì Expert A said that even though names like ‚Äúatan‚Äù and ‚ÄúHALF_PI‚Äù hint at trigonometry, ‚Äúneither the method name nor the local variables shed any light on the purpose of the method.‚Äù They described it as ‚Äúciphered,‚Äù understandable only with prior mathematical knowledge, and criticized its use of magic numbers. They also compared it to encodedLength, arguing that both methods fail to convey their purpose clearly.\n<br>‚Äì Expert B called the method ‚Äúterrible,‚Äù noting that one of the early branches seems to do nothing and that the final return value does not align with what one expects from an atan2-style computation. They grouped it with encodedLength and isMachineTypeDefined as methods that are ‚Äúhacky or cryptic,‚Äù containing errors or confusing design choices that require heavy mental debugging.\n<br>\n<br>*Expert E also placed atan2 in Position 8.\n<br>‚Äì They said understanding it requires reasoning about numerical methods and trigonometry. They contrasted it with encodedLength, saying that even though the UTF-8 code uses tricky bit-level logic, it still has an overall logical structure, whereas atan2 has a much less intuitive flow. They highlighted unusual constructs like ‚Äún != n‚Äù for NaN detection and quadrant-dependent arithmetic like ‚Äúx + HALF_PI,‚Äù which require reconstructing the intended behavior.\n<br>\n<br>*Experts C and D placed atan2 in Position 6.\n<br>‚Äì Expert C criticized the extremely short variable names (‚Äúx,‚Äù ‚Äúy,‚Äù ‚Äún‚Äù) and said the early if/else block adjusts values in edge cases without making the purpose clear. They said that at least in isMachineTypeDefined they could infer some logic from the name, whereas atan2 requires specific mathematical or library context. However, they still found it slightly easier than encodedLength, which they described as involving unfamiliar bitwise and UTF-8 concepts.\n<br>‚Äì Expert D said the overall intention is broadly understandable, but the cryptic naming, lack of braces, and complex control flow make the method harder to parse. They placed it above the most cryptic low-level encoding code but still within the harder tier.\n<br>\n<br>These differences show that some experts viewed atan2 as opaque without strong numerical-method and trigonometry background, while others judged it slightly more accessible than the trickiest low-level encoding logic but still difficult due to its unconventional flow, naming, and mathematical assumptions."
  }
];


    const username = localStorage.getItem("username") || "anonymous";
    const snippetOrder = JSON.parse(sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder') || '[]');

    let index = 0;

    function personalizeText(text, originalSnippetNumber) {
      const dynamicSnippetNum = snippetOrder ? snippetOrder.indexOf(originalSnippetNumber) + 1 : originalSnippetNumber;
      return text
        .replaceAll(`Snippet ${originalSnippetNumber}`, `Snippet ${dynamicSnippetNum}`)
        .replace(/\b(Oscar|Martin|Nadeeshan)\b/g, name => name.toLowerCase() === username.toLowerCase() ? `${name} (you)` : name);
    }


    const round4Responses = disagreements.map((_, i) => {
    const key = `round4_response_${i}`;
    const raw = sessionStorage.getItem(key) || localStorage.getItem(key);
    try {
        return raw ? JSON.parse(raw) : {};
    } catch {
        return {};
    }
    });



    function personalize(text, username, snippetMap) {
      // Replace expert name with "you"
      ['Oscar', 'Martin', 'Nadeeshan'].forEach(name => {
        const regex = new RegExp(`\\b${name}\\b`, 'gi');
        if (username.toLowerCase() === name.toLowerCase()) {
          text = text.replace(regex, `${name} (you)`);
        }
      });

      // Replace all variants of "snippet X" or "snippet X (funcName)", case-insensitively
      text = text.replace(/snippet (\d+)(?: \((.*?)\))?/gi, (match, origId, funcName, offset, fullText) => {
        const originalWord = fullText.slice(offset, offset + 7); // 'Snippet' or 'snippet' or mixed
        const capitalized = originalWord[0] === originalWord[0].toUpperCase();

        const originalId = parseInt(origId);
        const localId = snippetMap[originalId];

        if (!localId) {
          console.warn(`‚ö†Ô∏è Unknown original snippet: ${originalId}`);
          return match;
        }

        const label = `${capitalized ? 'Snippet' : 'snippet'} ${localId}`;
        const link = `<a href="javascript:void(0)" onclick="show_snippet(${localId})">${label}</a>`;
        return funcName ? `${link} (${funcName})` : link;
      });

      return text;
    }



    function getLocalSnippetMapping() {
        const stored = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder');
        if (!stored) return null;

        try {
            const parsed = JSON.parse(stored); // e.g., [3,1,4,7,8,2,6,5]
            const mapping = {};
            parsed.forEach((originalId, localIndex) => {
            mapping[originalId] = localIndex + 1; // original ID -> local snippet number
            });
            return mapping;
        } catch (e) {
            console.error("Failed to parse snippetOrder:", e);
            return null;
        }
    }

function markCurrentUserName(text, username) {
  return text.replace(/\b(Oscar|Martin|Nadeeshan)\b/g, name =>
    name.toLowerCase() === username.toLowerCase() ? `${name} (you)` : name
  );
}

    function getround4Response(i) {
        const key = `round4_response_${i}`;
        const raw = sessionStorage.getItem(key) || localStorage.getItem(key);
        try {
            return raw ? JSON.parse(raw) : {};
        } catch {
            return {};
        }
    }


    function render() {
        const container = document.getElementById('disagreement-box');
        const entry = disagreements[index];
        const localSnippets = getLocalSnippetMapping();
        const username = sessionStorage.getItem('username') || localStorage.getItem('username') || 'anonymous';

      container.classList.add("hidden")
      setTimeout(() => {
        container.innerHTML = `
            <h3 style="margin-bottom: 10px;">Disagreement ${index + 1}</h3>
            <div class="disagreement-text" style="margin-bottom: 20px;">
                ${personalize(entry.text, username, localSnippets)}
            </div>
        `;
        container.classList.remove("hidden");
      }, 400);



        const questionsContainer = document.getElementById('question-box');

        questionsContainer.innerHTML = `
          <div>
            <label><strong>1. Did any of the other experts‚Äô perspectives seem reasonable or worth reflecting on, even if you don‚Äôt fully agree with them?</strong></label><br>
            <textarea id="q1" placeholder="Your response..."></textarea>
          </div>

          <div>
            <label><strong>2. Did the other experts‚Äô feedback affect your understanding of the snippet‚Äôs difficulty or its comprehensibility for typical software engineers?</strong></label><br>
            <textarea id="q2" placeholder="Your response..."></textarea>
          </div>

          <div>
            <label><strong>3. Would you consider revising your ranking for this snippet later, after completing all the disagreement reflections?</strong></label><br>
            <textarea id="q3" placeholder="Your response..."></textarea>
          </div>
        `;


        // Restore saved answers
        const saved = getround4Response(index);
        document.getElementById('q1').value = saved.q1 || '';
        document.getElementById('q2').value = saved.q2 || '';
        document.getElementById('q3').value = saved.q3 || '';

        // ‚úÖ Show/hide previous button
        // document.getElementById('prevBtn').style.display = index === 0 ? 'none' : 'inline-block';


          const nextBtn = document.getElementById("nextBtn");
          if (index === disagreements.length - 1) {
              nextBtn.disabled = true;
              nextBtn.style.display = "none";
              if(areAllDisagreementsAnswered){
                  sessionStorage.setItem("round4-phase3-complete","true");
                  localStorage.setItem("round4-phase3-complete","true");
                  console.log("areAllDisagreementsAnswered3");
                  const continueBtn = document.getElementById('continueBtn');
                  continueBtn.style.display = 'inline-block';
                  continueBtn.style.backgroundColor = '#4CAF50';
                  continueBtn.style.animation = 'glowPulse 1.5s infinite alternate';
                  const phase4Link = document.getElementById('link-phase4');
                  if (phase4Link) {
                    phase4Link.classList.remove('disabled');
                  }
              } else{
                  sessionStorage.setItem("round4-phase3-complete","false");
                  localStorage.setItem("round4-phase3-complete","false");
              }
          } else {
              nextBtn.disabled = false;
            nextBtn.style.display = "block"; // optional
          }

        const prevBtn = document.getElementById("prevBtn");
        prevBtn.disabled = index === 0;
        // prevBtn.style.display = index === 0 ? 'none' : 'inline-block';

    }




    function next() {
        const q1 = document.getElementById('q1').value.trim();
        const q2 = document.getElementById('q2').value.trim();
        const q3 = document.getElementById('q3').value.trim();

        if (!q1 || !q2 || !q3) {
            showValidationMessage("‚ö†Ô∏è Please answer all three questions before continuing.");
            return;
        }

        saveround4Response(index, { q1, q2, q3 });

        if (index < disagreements.length - 1) {
            index++;
            render();
        } else {
            window.location.href = 'round4-phase4.html';
        }
        const el = document.getElementById('disagreement-box');
        const top = el.getBoundingClientRect().top + window.scrollY - 300;

        window.scrollTo({ top, behavior: 'smooth' });
      }


    function prev() {
        const q1 = document.getElementById('q1').value.trim();
        const q2 = document.getElementById('q2').value.trim();
        const q3 = document.getElementById('q3').value.trim();

        // Save current responses before moving back
        saveround4Response(index, { q1, q2, q3 });

        if (index > 0) {
            index--;
            render();
        }
        const el = document.getElementById('disagreement-box');
        const top = el.getBoundingClientRect().top + window.scrollY - 300;

        window.scrollTo({ top, behavior: 'smooth' });
    }



  </script>
  <script>
    function saveround4Response(stepIndex, responseObj) {
        const key = `round4_response_${stepIndex}`;
        const json = JSON.stringify(responseObj);

        sessionStorage.setItem(key, json);
        // document.cookie = `${key}=${encodeURIComponent(json)}; path=/; max-age=${60 * 60 * 24 * 30}`;
        localStorage.setItem(key,json);
    }
  </script>

  <script>

// Debounce utility
function debounce(fn, delay = 1000) {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn(...args), delay);
  };
}

// Create the debounced version once
const debouncedSaveToServer = debounce(saveToServer, 1000);

// Attach autosave listeners
function attachAutosaveListeners() {
  ['q1', 'q2', 'q3'].forEach(id => {
    const textarea = document.getElementById(id);
    if (textarea) {
      textarea.addEventListener('input', () => {
        const q1 = document.getElementById('q1').value.trim();
        const q2 = document.getElementById('q2').value.trim();
        const q3 = document.getElementById('q3').value.trim();

        saveround4Response(index, { q1, q2, q3 });
        debouncedSaveToServer(); // ‚úÖ debounced save
      });
    } else {
      console.warn(`‚ùó Missing textarea: #${id}`);
    }
  });
}




  </script>

<script>
    function showValidationMessage(msg) {
      alert(msg); // You can replace this with a styled modal if you prefer
    }
</script>
  
<script>
      function loadCards() {
      const container = document.getElementById('cards');
      snippets.forEach(snippet => {
        const card = document.createElement('div');
        card.className = 'card';
        card.draggable = true;
        card.id = `snippet-${snippet.id}`;
        card.innerHTML = `
          <strong>${snippet.title}</strong>
          <br><label><input type="checkbox" onchange="togglePreview(${snippet.id}, this)"> View</label>
        `;
        card.addEventListener('dragstart', () => card.classList.add('dragging'));
        card.addEventListener('dragend', () => card.classList.remove('dragging'));
        container.appendChild(card);
      });

      document.querySelectorAll('.ranking-slot').forEach(slot => {
        slot.addEventListener('dragover', e => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging');
          if (dragging) slot.appendChild(dragging);
          saveState();
        });
      });
    }

    function loadState() {
      let saved = sessionStorage.getItem('phase3_ranking') || localStorage.getItem("phase3_ranking");

      if (!saved) {
        const cookieMatch = document.cookie.match(/(?:^|; )phase3_ranking=([^;]*)/);
        if (cookieMatch) {
          saved = decodeURIComponent(cookieMatch[1]);  // ‚úÖ decode before parsing
          sessionStorage.setItem('phase3_ranking', saved);
        }
      }

      if (!saved) return;

      try {
        const parsed = JSON.parse(saved);  // now valid JSON
        Object.entries(parsed).forEach(([rank, ids]) => {
          const slot = document.querySelector(`.ranking-slot[data-rank='${rank}']`);
          ids.forEach(id => {
            const el = document.getElementById(id);
            if (el && slot) slot.appendChild(el);
          });
        });
      } catch (e) {
        console.error('Failed to parse phase3_ranking JSON:', e);
      }
    } 

    function areAllDisagreementsAnswered() {
              const q1 = document.getElementById('q1').value.trim();
        const q2 = document.getElementById('q2').value.trim();
        const q3 = document.getElementById('q3').value.trim();

        if (!q1 || !q2 || !q3) {
            // showValidationMessage("‚ö†Ô∏è Please answer all three questions before continuing.");
            return;
        }
  for (let i = 0; i < disagreements.length; i++) {
    const key = `round4_response_${i}`;
    const dataStr = sessionStorage.getItem(key) || localStorage.getItem(key);

    if (!dataStr) return false;

    try {
      const data = JSON.parse(dataStr);
      const q1 = data.q1?.trim();
      const q2 = data.q2?.trim();
      const q3 = data.q3?.trim();

      if (!q1 || !q2 || !q3) return false;
    } catch (e) {
      console.warn(`Invalid JSON for key ${key}`);
      return false;
    }
  }
  return true;
}

</script>

<script>
      function saveState() {
      const positions = {};
      document.querySelectorAll('.ranking-slot').forEach((slot, index) => {
        positions[index + 1] = Array.from(slot.children).map(el => el.id);
      });
      const json = JSON.stringify(positions);
      sessionStorage.setItem('phase3_ranking', json);
      document.cookie = `phase3_ranking=${encodeURIComponent(json)}; path=/; max-age=${60 * 60 * 24 * 30}`;

      /* Check if the phase is completed */
      if (areAllDisagreementsAnswered()) {
        console.log("areAllDisagreementsAnswered6");
        document.getElementById('continueBtn').style.display = 'inline-block';
        document.getElementById('continueBtn').style.backgroundColor = '#4CAF50';
        document.getElementById('continueBtn').style.animation = 'glowPulse 1.5s infinite alternate';
        sessionStorage.setItem('round4-phase2-complete', 'true');
        document.cookie = `round4-phase2-complete=true; path=/; max-age=${60 * 60 * 24 * 30}`;

        // ‚úÖ Also update the status bar
        const phase3Link = document.getElementById('link-phase3');
        if (phase3Link) {
          phase3Link.classList.remove('disabled');
        }
      } else {
        sessionStorage.removeItem('phase2Complete');
        document.cookie = `phase2Complete=; path=/; max-age=0`;
        document.getElementById('continueBtn').style.display = 'none';
        const phase3Link = document.getElementById('link-phase3');
        if (phase3Link) {
          phase3Link.classList.add('disabled');
        }
      }

    }
</script>

<script>
      function show_snippet(id) {
    const snippet = snippets.find(s => s.id === id);
    if (!snippet) return;

    document.getElementById('modal-snippet-title').innerText = snippet.title;

    const codeLines = snippet.code.trim().split('\n');

    // ‚úÖ Use innerHTML here to render styled spans correctly
    document.getElementById('modal-code-content').innerHTML = codeLines.join('\n');

    // ‚úÖ Line numbers are just plain numbers
    document.getElementById('modal-line-numbers').innerHTML = codeLines.map((_, i) => i + 1).join('<br>');

    document.getElementById('snippet-modal').style.display = 'block';

    applyModalTheme(); // Keep the theme consistent
    }

    
    function toggleModalTheme() {
      const body = document.body;
      const isLight = body.classList.contains("light-mode");
    
      if (isLight) {
        body.classList.remove("light-mode");
        body.classList.add("dark-mode");
        localStorage.setItem("codeTheme", "dark");
        document.getElementById('modal-theme-toggle').textContent = "Switch to Light Mode";
      } else {
        body.classList.remove("dark-mode");
        body.classList.add("light-mode");
        localStorage.setItem("codeTheme", "light");
        document.getElementById('modal-theme-toggle').textContent = "Switch to Dark Mode";
      }
    }
    
    function applyModalTheme() {
      const theme = localStorage.getItem('codeTheme') || 'light';
      document.body.classList.remove('light-mode', 'dark-mode');
      document.body.classList.add(theme + '-mode');
      document.getElementById('modal-theme-toggle').textContent =
        theme === 'light' ? "Switch to Dark Mode" : "Switch to Light Mode";
    }
</script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const section = document.getElementById('phase-section-content');
  const handle = document.getElementById('phase2-resize-handle');

  if (!section || !handle) {
    console.warn("Resizable elements not found");
    return;
  }

  const savedHeight = localStorage.getItem('phaseSectionHeight');
  if (savedHeight) section.style.height = savedHeight;

  let isResizing = false;

  handle.addEventListener('mousedown', () => {
    isResizing = true;
    document.body.style.cursor = 'ns-resize';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;

    const newHeight = e.clientY - section.getBoundingClientRect().top;
    const clampedHeight = Math.max(newHeight, 50);
    section.style.height = clampedHeight + 'px';
    localStorage.setItem('phaseSectionHeight', section.style.height);
  });

  document.addEventListener('mouseup', () => {
    isResizing = false;
    document.body.style.cursor = '';
  });
});

</script>

<script>
window.addEventListener('scroll', function () {
  const el = document.getElementById('scroll-trigger-element');
  const content = document.getElementById("instructions-content");
  const button = document.getElementById("instructions-content-btn");
  const contentRanking = document.getElementById('phase-section-content');

  if (window.scrollY >= 200) {
    el.classList.add('visible');
    // content.style.display = "none";
    // button.textContent = "Show";
  }

  if (window.scrollY >= 70) {
    el.classList.add('visible');
    // content.style.display = "none";
    // button.textContent = "Show";
  } else if (window.getComputedStyle(contentRanking).display === "none") {
    el.classList.remove('visible');
  }
});

</script>

<script>

function togglePhaseSection() {
  const section = document.getElementById('phase-section-content');
  const handle = document.getElementById('phase2-resize-handle');
  const button = document.querySelector('.toggle-btn');

  const isVisible = section.style.display === 'block';

  // Toggle content
  section.style.display = isVisible ? 'none' : 'block';

  // Show/hide handler only if content is visible
  handle.style.display = isVisible ? 'none' : 'block';

  // Adjust page layout
  const phaseBar = document.querySelector('.phase-bar');
  const body = document.body;
  setTimeout(() => {
    const extraHeight = phaseBar.offsetHeight;
    body.style.marginTop = `${extraHeight + 50}px`;
  }, 0);

  // Update button label
  button.textContent = isVisible ? 'Show' : 'Hide';
}



</script>

<script>
  function openJavadocModal(url) {
    const iframe = document.getElementById("javadocFrame");
    iframe.src = url;
    document.getElementById("javadocModal").style.display = "block";
  }

  function closeJavadocModal() {
    document.getElementById("javadocModal").style.display = "none";
    document.getElementById("javadocFrame").src = "";
  }

  function javadocFrameReload() {
    const iframe = document.getElementById("javadocFrame");
    iframe.src = iframe.src;
  }


</script>
<footer
  style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 14px; color: #666;">
  Please contact us if you have any questions or issues: <a href="mailto:ea442@njit.edu">ea442@njit.edu</a>
</footer>
</body>
</html>
