<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phase 4: CS Knowledge Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#4CAF50; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0 40px 40px; background:#f9f9f9; color:#333; }
    .status-bar { position:fixed; top:0; left:0; right:0; z-index:1000; background:#333; color:#fff; display:flex; align-items:center; gap:30px; padding:10px 20px; }
    .phase-link { color:#fff; text-decoration:none; font-weight:600; padding:8px 12px; border-radius:4px; }
    .phase-link:hover:not(.disabled) { background: var(--brand); }
    .phase-link.active { background: var(--brand); }
    .phase-link.disabled { pointer-events:none; opacity:.5; cursor:not-allowed; }
    .user-dropdown { margin-right:auto; }

    .card { background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.1); margin-top:90px; }
    h2 { margin:0 0 10px; }
    .progress { height:6px; background:#eee; border-radius:4px; overflow:hidden; margin:8px 0 16px; }
    .progress span { display:block; height:100%; background:var(--brand); width:0%; transition:width .3s ease; }
    #qtext { font-size:16px; margin:6px 0 12px; }
    #opts label { display:block; margin:8px 0; }
    textarea.input-field { width:100%; padding:12px 14px; font-size:16px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:18px; }
    button { padding:10px 16px; border:none; border-radius:6px; font-size:15px; cursor:pointer; }
    button.primary { background:var(--brand); color:#fff; }
    button.primary:hover { filter:brightness(.95); }
    button[disabled] { opacity:.6; cursor:not-allowed; }

    /* Timer controls (kept consistent with other phases) */

    /* Validation modal */
    #validation-modal{ display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%); background:#fff0f0; color:#660000; border:1px solid #ff9999; padding:20px; border-radius:10px; width:440px; box-shadow:0 4px 16px rgba(0,0,0,.2); z-index:1002; text-align:center; }
    #validation-modal button{ margin-top:12px; background:#ff9999; color:#fff; }

    .hint { font-size:13px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <!-- Top status/nav consistent with other phases -->
  <div class="status-bar">
    <div class="user-dropdown" style="position: relative;">
      <div style="padding: 8px 12px; color: gainsboro; font-weight: bold;"><span id="user-info"></span> (<button
          onclick="logout()"
          style="color: white; background: none; border: none; cursor: pointer; margin: 0;padding: 0;">üö™
          Logout</button>)</div>
    </div>
    <a href="index.html" class="phase-link" id="link-home">üè† Home</a>
    <a href="phase1.html" class="phase-link" id="link-phase1">Phase 1</a>
    <a href="phase2.html" class="phase-link" id="link-phase2">Phase 2</a>
    <a href="phase3.html" class="phase-link" id="link-phase3">Phase 3</a>
    <a href="review.html" class="phase-link disabled" id="link-review">Review & Submit</a>
  </div>
  
  <!-- Instructions -->
  <div class="card" id="instructions">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Phase 4: CS Knowledge Survey</h2>
      <button onclick="document.getElementById('instructions-body').classList.toggle('hidden'); this.textContent = (document.getElementById('instructions-body').classList.contains('hidden') ? 'Show' : 'Hide');" style="background:#fff; border:1px solid #ccc; color:#222;">Hide</button>
    </div>
    <div id="instructions-body">
      <p>In this final phase, please answer a short CS familiarity survey. If you answer <em>Yes</em> to a topic, you‚Äôll get one quick multiple‚Äëchoice question. If you answer <em>No</em>, we‚Äôll skip the MCQ for that topic.</p>
      <p class="hint"><strong>Note:</strong> You can‚Äôt change a ‚ÄúYes/No‚Äù once you‚Äôve moved on to the MCQ for that topic. This keeps the flow consistent for everyone.</p>
    </div>
  </div>

  <!-- Survey Card -->
  <div class="card" id="survey-card">
    <div class="progress"><span id="bar"></span></div>
    <div id="qtext"></div>
    <div id="opts"></div>
    <div class="row">
      <button id="prev" class="" onclick="goPrev()">Previous</button>
      <div style="display:flex; gap:8px;">
        <button class="primary" id="next">Next</button>
        <button id="goto-review" class="primary" style="display:none;" onclick="finishPhase4()">Go to Review & Submit</button>
      </div>
    </div>
  </div>

  <!-- Validation Modal -->
  <div id="validation-modal">
    <p id="validation-message" style="font-weight:700;"></p>
    <button onclick="document.getElementById('validation-modal').style.display='none'">OK</button>
  </div>

  <script>
    /* ---------- Session checks & nav state ---------- */
    function displayUserName(){ const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName'); if(name){ document.getElementById('user-info').textContent = `üë§ ${name}`; } }
    function isLoggedIn(){ const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName'); const order = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder'); return !!(name && order); }
    function checkLogin(){ if(!isLoggedIn()){ alert('You must be logged in to access this page. Redirecting to the homepage.'); window.location.href = '/'; } }
    function markNav(){
      // Enable earlier phases based on flags
      if (sessionStorage.getItem('phase1Complete')==='true' || localStorage.getItem('phase1Complete')==='true') document.getElementById('link-phase2')?.classList.remove('disabled');
      if (sessionStorage.getItem('phase2Complete')==='true' || localStorage.getItem('phase2Complete')==='true') document.getElementById('link-phase3')?.classList.remove('disabled');
      if (sessionStorage.getItem('phase3Complete')==='true' || localStorage.getItem('phase3Complete')==='true') document.getElementById('link-review')?.classList.remove('disabled');
      // Mark Phase 4 as active visually
      document.getElementById('link-phase4')?.classList.add('active');
    }
    window.addEventListener('load', checkLogin);

    /* ---------- Validation helper ---------- */
    function showValidationMessage(msg){ document.getElementById('validation-message').textContent = msg; document.getElementById('validation-modal').style.display='block'; }

    /* ---------- Survey content (from your provided page) ---------- */
    const topics = [
      { id:"uri_scheme", tag:"URIs", familiarity:{ q:"Are you familiar with the concept of Uniform Resource Identifier (URI) schemes?" }, mcq:{ q:"Which part of ‚Äúhttp://example.com/page.html‚Äù is the URI scheme?", options:["example.com","http","/page.html","://"], correctIndex:1 } },
      { id:"file_vs_network_uri", tag:"URIs", familiarity:{ q:"Do you know the difference between filesystem URIs and remote/network URIs?" }, mcq:{ q:"What is the main difference between a file:// URI and http:// or ftp:// URIs?", options:["file:// URIs are always encrypted, while http:// and ftp:// are not","file:// URIs can only be used on Linux, while http:// and ftp:// work everywhere","file:// URIs automatically delete files, while http:// and ftp:// only read them","file:// URIs refer to local filesystem resources, while http:// and ftp:// URIs refer to network resources"], correctIndex:3 } },
      { id:"reflection", tag:"Java", familiarity:{ q:"Are you familiar with the Java Reflection API?" }, mcq:{ q:"Which of the following is an example of reflection?", options:["Checking if a variable is null","Writing a loop to iterate over numbers","Converting an integer to a string","Listing all methods of an object at runtime"], correctIndex:3 } },
      { id:"visitor_walkFileTree", tag:"Java", familiarity:{ q:"Are you familiar with the Visitor design pattern, particularly as used in Java‚Äôs Files.walkFileTree API?" }, mcq:{ q:"What is the main purpose of using the Visitor pattern in Files.walkFileTree?", options:["It lets you define what happens at each file or directory visit while the API handles the traversal logic.","It automatically performs recursive deletion of directories.","It provides faster traversal by avoiding recursion.","It stores metadata about files and directories for later access."], correctIndex:0 } },
      { id:"utf8_utf16", tag:"Unicode", familiarity:{ q:"Do you know the difference between UTF-8 and UTF-16 Unicode encodings?" }, mcq:{ q:"Which statement best describes the main difference between UTF-8 and UTF-16?", options:["UTF-8 is fixed-length, while UTF-16 is variable-length.","UTF-16 is backward compatible with ASCII, while UTF-8 is not.","UTF-8 and UTF-16 both use exactly 2 bytes for every character.","UTF-8 uses 1 to 4 bytes per character, while UTF-16 uses 2 or 4 bytes per character."], correctIndex:3 } },
      { id:"bitwise_ops", tag:"Bits", familiarity:{ q:"Do you know what bitwise operators (e.g., &, |, ^, >>, >>>) do in programming?" }, mcq:{ q:"In Java, what does the operator >>> do?", options:["Signed right shift (preserves the sign bit)","Unsigned right shift (fills left bits with zeros)","Left shift (fills right bits with zeros)","Bitwise OR"], correctIndex:1 } },
      { id:"hex_to_dec", tag:"Number Systems", familiarity:{ q:"Do you know how to convert between hexadecimal and decimal numbers without using a calculator?" }, mcq:{ q:"What is the decimal value of the hexadecimal constant 0x7F?", options:["80","127","128","255"], correctIndex:1 } },
      { id:"quadratic", tag:"Math", familiarity:{ q:"Are you familiar with the quadratic formula?" }, mcq:{ q:"The quadratic formula gives the roots of ax¬≤ + bx + c = 0 as:", options:["(‚Äìb ¬± ‚àö(b¬≤ ‚Äì 4ac)) / (2a)","(‚Äìa ¬± ‚àö(a¬≤ ‚Äì 4bc)) / (2b)","(‚Äìc ¬± ‚àö(c¬≤ ‚Äì 4ab)) / (2a)","(‚Äìb ¬± ‚àö(a¬≤ + b¬≤ + c¬≤)) / (2)"], correctIndex:0 } },
      { id:"atan", tag:"Math", familiarity:{ q:"Are you familiar with the arctangent (atan) function?" }, mcq:{ q:"The function Math.atan(x) is used to:", options:["Compute the magnitude of a vector","Compute the angle of a vector in the correct quadrant","Convert radians to degrees","Calculate sine and cosine simultaneously"], correctIndex:1 } },
      { id:"nan", tag:"Floating Point", familiarity:{ q:"Are you familiar with the concept of NaN (Not a Number) and its behavior in Java?" }, mcq:{ q:"In Java, when x is a floating-point variable, which of the following expressions evaluates to true if and only if x is NaN?", options:["x == NaN","x != x","x++ > x","It is not possible to check for NaN in Java"], correctIndex:1 } },
      { id:"fp_singularities", tag:"Floating Point", familiarity:{ q:"Are you familiar with Java‚Äôs handling of floating-point singularities (such as division by zero)?" }, mcq:{ q:"What is the result of evaluating 1.0 / 0.0 in Java?", options:["NaN","Infinity","0.0","Throws an exception"], correctIndex:1 } }
    ];

    // State: per-topic answers, step = 'fam' or 'mcq'
    const qtext = document.getElementById('qtext');
    const opts  = document.getElementById('opts');
    const bar   = document.getElementById('bar');
    const prevB = document.getElementById('prev');
    const nextB = document.getElementById('next');
    const gotoReviewB = document.getElementById('goto-review');

    let state = { i:0, step:'fam', answers:{} };

    function saveState(){ localStorage.setItem('csKnowledgeSurveyAnswers', JSON.stringify(state.answers)); }
    function loadState(){ const saved = localStorage.getItem('csKnowledgeSurveyAnswers'); if(saved){ try{ state.answers = JSON.parse(saved)||{}; }catch{} } }

    function render(){
      const t = topics[state.i];
      bar.style.width = `${(state.i / topics.length) * 100}%`;
      opts.innerHTML = '';
      const rec = state.answers[t.id] || {};

      if(state.step === 'fam'){
        qtext.textContent = t.familiarity.q;
        const locked = rec.mcq !== undefined; // lock fam once MCQ answered
        const yes = document.createElement('label');
        yes.innerHTML = `<input type="radio" name="f" value="yes" ${rec.fam==='yes'?'checked':''} ${locked?'disabled':''}> Yes`;
        const no = document.createElement('label');
        no.innerHTML = `<input type="radio" name="f" value="no" ${rec.fam==='no'?'checked':''} ${locked?'disabled':''}> No`;
        opts.append(yes,no);
        nextB.disabled = !rec.fam;
      } else {
        qtext.textContent = t.mcq.q;
        t.mcq.options.forEach((o,i)=>{
          const l=document.createElement('label');
          const checked = (rec.mcq===i)?'checked':'';
          l.innerHTML = `<input type="radio" name="m" value="${i}" ${checked}> ${String.fromCharCode(65+i)}) ${o}`;
          opts.append(l);
        });
        nextB.disabled = (rec.mcq===undefined);
      }

      prevB.disabled = (state.i===0 && state.step==='fam');
    }

    opts.addEventListener('change', (e)=>{
      const t = topics[state.i];
      const rec = state.answers[t.id] || {};
      if(state.step==='fam' && e.target?.name==='f'){
        rec.fam = e.target.value;
        if(rec.fam==='no') delete rec.mcq; // clear mcq if switching to no
      }
      if(state.step==='mcq' && e.target?.name==='m'){
        rec.mcq = parseInt(e.target.value,10);
      }
      state.answers[t.id] = rec;
      saveState();
      nextB.disabled = false;
    });

    nextB.onclick = ()=>{
      const t = topics[state.i];
      const rec = state.answers[t.id] || {};
      if(state.step==='fam'){
        if(!rec.fam) { showValidationMessage('Please select Yes or No.'); return; }
        state.step = (rec.fam==='yes') ? 'mcq' : 'fam';
        if(rec.fam==='no'){ state.i++; }
      } else {
        if(rec.mcq===undefined){ showValidationMessage('Please select an option.'); return; }
        state.i++; state.step='fam';
      }

      if(state.i >= topics.length){
        bar.style.width = '100%';
        // mark complete & enable Review
        localStorage.setItem('phase4Complete','true');
        document.getElementById('link-review')?.classList.remove('disabled');
        gotoReviewB.style.display='inline-block';
        nextB.style.display='none';
        qtext.textContent = 'All done with the CS Knowledge Survey!';
        opts.innerHTML = '<div class="hint">Click <strong>Go to Review & Submit</strong> to finish.</div>';
        return;
      }
      render();
    };

    function goPrev(){
      const t = topics[state.i];
      const rec = state.answers[t.id] || {};
      // From MCQ -> fam of same topic; From fam -> previous topic (to its MCQ if fam was yes)
      if(state.step==='mcq'){
        state.step='fam';
      } else {
        if(state.i>0){
          state.i--; const prevT = topics[state.i]; const prevRec = state.answers[prevT.id] || {};
          state.step = (prevRec.fam==='yes') ? 'mcq' : 'fam';
        }
      }
      render();
    }

    function finishPhase4(){
      // Persist a simple summary (optional; your server combines this later in submitFinalAnswersToServer)
      const answers = JSON.parse(localStorage.getItem('csKnowledgeSurveyAnswers')||'{}');
      const topicIds = Object.keys(answers);
      const totalTopics = topicIds.length;
      let famYes=0, mcqAnswered=0; topicIds.forEach(id=>{ const r=answers[id]||{}; if(r.fam==='yes') famYes++; if(typeof r.mcq==='number') mcqAnswered++; });
      localStorage.setItem('csKnowledgeSurveySummary', JSON.stringify({totalTopics,famYes,mcqAnswered}));

      // Mark phase4 complete + enable Review
      localStorage.setItem('phase4Complete','true');
      document.getElementById('link-review')?.classList.remove('disabled');
      // Navigate to review page
      window.location.href = 'review.html';
    }

    // initial
    loadState();
    render();

    /* ---------- Save progress ping (matches other phases) ---------- */
    function saveToServer(){
      const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName') || 'Anonymous';
      const username = localStorage.getItem('username') || localStorage.getItem('usernameS') || 'anonymous';
      const phase1 = {}; // keep payload shape consistent even if unused here
      for(let i=1;i<=8;i++){ const summary = sessionStorage.getItem(`summary${i}`)||localStorage.getItem(`summary${i}`)||''; const comp = sessionStorage.getItem(`compSummary${i}`)||localStorage.getItem(`compSummary${i}`)||''; phase1[`snippet${i}`] = { summary, comprehensibility: comp }; }
      let phase2={}, phase3={};
      try{ phase2 = JSON.parse(sessionStorage.getItem('phase3_ranking')||localStorage.getItem('phase3_ranking')||'{}'); }catch{}
      try{ phase3 = JSON.parse(sessionStorage.getItem('phase3_reasoning')||localStorage.getItem('phase3_reasoning')||'{}'); }catch{}

      const flags = {
        phase1Complete: sessionStorage.getItem('phase1Complete')||localStorage.getItem('phase1Complete')||'false',
        phase2Complete: sessionStorage.getItem('phase2Complete')||localStorage.getItem('phase2Complete')||'false',
        phase3Complete: sessionStorage.getItem('phase3Complete')||localStorage.getItem('phase3Complete')||'false',
        phase4Complete: localStorage.getItem('phase4Complete')||'false',
        codeTheme: localStorage.getItem('codeTheme')||'light',
        submitted: '0',
      };

      const payload = { username, participantName:name, phase1, phase2, phase3, ...flags };
      const blob = new Blob([JSON.stringify(payload)], { type:'application/json' });
      navigator.sendBeacon('/submit_final', blob);
    }
    window.addEventListener('beforeunload', saveToServer);

    /* ---------- Auth helpers ---------- */
    function logout(){ sessionStorage.clear(); localStorage.clear(); document.cookie.split(';').forEach(c=>{ const n=c.split('=')[0].trim(); document.cookie=`${n}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`; }); window.location.href='index.html'; }
  </script>
</body>
</html>
