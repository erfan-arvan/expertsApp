<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Phase 4: Explain Your Ranking Decisions</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 40px 40px 40px;
      background-color: #f9f9f9;
    }

    .step-box {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .status-bar {
      background-color: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .phase-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .phase-link:hover:not(.disabled) {
      background-color: #4CAF50;
    }

    .phase-link.active {
      background-color: #4CAF50;
    }

    .phase-link.disabled {
      pointer-events: none;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .snippet-preview-box {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background-color: #fefefe;
      border: 1px solid #bbb;
      margin-bottom: 20px;
    }

    .snippet-header {
      background-color: #f5f5f5;
      padding: 10px 15px;
      font-weight: bold;
      font-size: 16px;
      border-bottom: 1px solid #ccc;
    }

    .code-box {
      background-color: #f9f9f9;
      color: #222;
      padding: 0;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      margin-bottom: 20px;
    }

    .code-container {
      display: grid;
      grid-template-columns: auto 1fr;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.5;
      background-color: inherit;
      color: inherit;
      overflow-x: auto;
      padding: 0;
    }

    .line-numbers {
      text-align: right;
      padding-right: 12px;
      user-select: none;
      color: #999;
      border-right: 1px solid #ccc;
    }

    .code-content {
      padding-left: 12px;
      white-space: pre;
      word-break: break-word;
    }

    textarea {
      width: 100%;
      height: 120px;
      font-size: 14px;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .buttons {
      text-align: center;
      margin-top: 30px;
    }

    button {
      padding: 10px 20px;
      margin-right: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    button[disabled] {
      background-color: #888;
      cursor: not-allowed;
    }

    button#submit-review {
      display: none;
      animation: glowPulse 1.5s infinite alternate;
    }

    @keyframes glowPulse {
      0% {
        box-shadow: 0 0 10px #4CAF50;
      }

      100% {
        box-shadow: 0 0 20px #4CAF50, 0 0 30px #4CAF50;
      }
    }

    /* Light/Dark mode support */

    body.dark-mode .snippet-preview-box {
      background-color: #1e1e1e;
      border: 1px solid #444;
    }

    body.dark-mode .code-box {
      background-color: #2d2d2d;
      color: #ddd;
    }

    body.dark-mode .line-numbers {
      color: #777;
      border-right: 1px solid #555;
    }

    body.dark-mode .card {
      background-color: #2a2a2a;
      border-color: #555;
      color: #ddd;
    }

    /* Syntax Highlighting */
    .keyword {
      color: #0000ff;
      font-weight: bold;
    }

    .type {
      color: #007070;
    }

    .function {
      color: #7928a1;
      font-weight: bold;
    }

    .literal {
      color: #009999;
    }

    .string {
      color: #a31515;
    }

    .comment {
      color: #6a9955;
      font-style: italic;
    }

    .number {
      color: #098658;
    }

    .dark-mode .keyword {
      color: #82aaff;
    }

    .dark-mode .type {
      color: #89ddff;
    }

    .dark-mode .function {
      color: #c792ea;
    }

    .dark-mode .literal {
      color: #ffcb6b;
    }

    .dark-mode .string {
      color: #c3e88d;
    }

    .dark-mode .comment {
      color: #7f848e;
    }

    .dark-mode .number {
      color: #f78c6c;
    }

    html {
      scroll-behavior: smooth;
    }

    a {
      color: #4CAF50;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }


    .comparison-container {
      display: flex;
      gap: 40px;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    #code-comparison {
      flex: 2;
      min-width: 60%;
      max-width: 80%;
      box-sizing: border-box;
    }

    .explanation-box {
      flex: 1;
      min-width: 20%;
      max-width: 40%;
      box-sizing: border-box;
    }

    .explanation-box textarea {
      width: 100%;
      box-sizing: border-box;
    }
    .card {background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;}
  </style>

</head>

<body>

  <div class="status-bar">
    <div class="user-dropdown" style="position: relative;">
      <div style="padding: 8px 12px; color: gainsboro; font-weight: bold;"><span id="user-info"></span> (<button
          onclick="logout()"
          style="color: white; background: none; border: none; cursor: pointer; margin: 0;padding: 0;">üö™
          Logout</button>)</div>
    </div>
    <a href="index.html" class="phase-link" id="link-home">üè† Home</a>
    <a href="phase1.html" class="phase-link" id="link-phase1">Phase 1</a>
    <a href="phase2.html" class="phase-link" id="link-phase2">Phase 2</a>
    <a href="phase3.html" class="phase-link" id="link-phase3">Phase 3</a>
    <a href="phase4.html" class="phase-link" id="link-phase4">Phase 4</a>
    <a href="review.html" class="phase-link disabled" id="link-review">Review & Submit</a>
  </div>



  <!-- Instructions -->
     <div id="instructions-box"
    style="background-color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 80px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">Phase 4: A short familiarity survey</h2>
      <button onclick="toggleInstructions()"
        style="padding: 6px 12px; font-size: 14px; border-radius: 5px; background-color: #ffffff; border: none; cursor: pointer; color: #222; border: solid;">Hide</button>
    </div>

    <div id="instructions-content" style="margin-top: 15px;">
      <p>In this final phase, please answer a short familiarity survey.</p>
      <p>Note: your answers to this survey will <strong>not</strong> be shared with other experts.</p>
    </div>
  </div>


  <!-- Survey Card -->
  <div class="card" id="survey-card">
    <div class="progress"><span id="bar"></span></div>
    <div id="qtext"></div>
    <div id="opts"></div>
    <div class="row" 
        style="display: flex; align-items: center; justify-content: space-between; margin-top: 12px;">
      <button id="prev" onclick="goPrev()">Previous</button>
      <div style="display: flex;">
        <button class="primary" id="next">Next</button>
        <button id="goto-review" class="primary" style="display:none;" onclick="finishPhase4()">Go to Review & Submit</button>
      </div>
    </div>

  </div>

    <div id="validation-modal" style="
  display: none;
  position: fixed;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #fff0f0;
  color: #660000;
  border: 1px solid #ff9999;
  padding: 20px;
  border-radius: 10px;
  width: 440px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  z-index: 1002;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  ">
    <p id="validation-message" style="font-weight: bold;"></p>
    <button onclick="document.getElementById('validation-modal').style.display = 'none';" style="
      margin-top: 15px;
      padding: 8px 14px;
      background-color: #ff9999;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    ">OK</button>
  </div>

  <script>
    /* ---------- Session checks & nav state ---------- */
    function displayUserName(){ const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName'); if(name){ document.getElementById('user-info').textContent = `üë§ ${name}`; } }
    function isLoggedIn(){ const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName'); const order = sessionStorage.getItem('snippetOrder') || localStorage.getItem('snippetOrder'); return !!(name && order); }
    function checkLogin(){ if(!isLoggedIn()){ alert('You must be logged in to access this page. Redirecting to the homepage.'); window.location.href = '/'; } }
    function markNav(){
      // Enable earlier phases based on flags
      if (sessionStorage.getItem('phase1Complete') === 'true') {
        document.getElementById('link-phase2')?.classList.remove('disabled');
      }
      if (sessionStorage.getItem('phase2Complete') === 'true') {
        document.getElementById('link-phase3')?.classList.remove('disabled');
      }
      if (sessionStorage.getItem('phase3Complete') === 'true') {
        document.getElementById('link-phase4')?.classList.remove('disabled');
      }
      if (sessionStorage.getItem('phase4Complete') === 'true') {
        document.getElementById('link-review')?.classList.remove('disabled');
      }
      // Mark Phase 4 as active visually
      document.getElementById('link-phase4')?.classList.add('active');
    }
    window.addEventListener('load', checkLogin);

    /* ---------- Validation helper ---------- */
    function showValidationMessage(msg){ document.getElementById('validation-message').textContent = msg; document.getElementById('validation-modal').style.display='block'; }

 
    /* ---------- Auth helpers ---------- */
    function logout(){ sessionStorage.clear(); localStorage.clear(); document.cookie.split(';').forEach(c=>{ const n=c.split('=')[0].trim(); document.cookie=`${n}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`; }); window.location.href='index.html'; }
  </script>

  <script>

  window.onload = () => {
    // If you have a theme system on this page, call applyTheme(); otherwise remove this line.
    if (typeof applyTheme === 'function') applyTheme();
    if (typeof displayUserName === 'function') displayUserName();

    // Restore any Phase 4 survey state from localStorage if needed (already stored as csKnowledgeSurveyAnswers)
    // (No cookie restore here; Phase 4 uses localStorage.)

    // Mark completed phases (enable nav links)
      if (isComplete("phase1Complete"))
        document.getElementById("link-phase2").classList.remove("disabled");
      if (isComplete("phase2Complete"))
        document.getElementById("link-phase3").classList.remove("disabled");
      if (isComplete("phase3Complete"))
        document.getElementById("link-phase4").classList.remove("disabled");
      if (isComplete("phase4Complete"))
        document.getElementById("link-review").classList.remove("disabled");

    // Highlight current tab (includes Phase 4)
    const current = window.location.pathname.split('/').pop() || '';
    if (current.includes('phase1')) document.getElementById('link-phase1')?.classList.add('active');
    else if (current.includes('phase2')) document.getElementById('link-phase2')?.classList.add('active');
    else if (current.includes('phase3')) document.getElementById('link-phase3')?.classList.add('active');
    else if (current.includes('phase4')) document.getElementById('link-phase4')?.classList.add('active');
    else if (current.includes('review')) document.getElementById('link-review')?.classList.add('active');

    // Show/hide the "Go to Review & Submit" button based on Phase 4 completion
    const gotoBtn = document.getElementById('goto-review');
    const phase4Complete =
      localStorage.getItem('phase4Complete') === 'true' ||
      (typeof validatePhase4 === 'function' && validatePhase4());

    if (phase4Complete) {
      localStorage.setItem('phase4Complete', 'true');
      document.getElementById('link-review')?.classList.remove('disabled');
      if (gotoBtn) gotoBtn.style.display = 'inline-block';
    } else {
      localStorage.setItem('phase4Complete', 'false');
      if (gotoBtn) gotoBtn.style.display = 'none';
    }

    // Re-check once after the UI initializes (mirrors your Phase 3 setTimeout)
    setTimeout(() => {
      const ok = (typeof validatePhase4 === 'function') && validatePhase4();
      if (ok) {
        localStorage.setItem('phase4Complete', 'true');
        document.getElementById('link-review')?.classList.remove('disabled');
        if (gotoBtn) gotoBtn.style.display = 'inline-block';
      } else {
        localStorage.setItem('phase4Complete', 'false');
        if (gotoBtn) gotoBtn.style.display = 'none';
      }
    }, 500);

    // Auto-save to server every 2 minutes (same pattern you use elsewhere)
    setInterval(() => {
      try {
        if (typeof saveToServer === 'function') {
          saveToServer();
          console.log('[Auto-Save] Progress saved to server.');
        }
      } catch (e) {
        console.warn('[Auto-Save] Failed to save:', e);
      }
    }, 120000);
  };
</script>
<script>
    function toggleInstructions() {
    const content = document.getElementById("instructions-content");
    const button = event.target;

    if (content.style.display === "none") {
      content.style.display = "block";
      button.textContent = "Hide";
    } else {
      content.style.display = "none";
      button.textContent = "Show";
    }
  }

      function isComplete(key) {
      return (
        sessionStorage.getItem(key) === "true" ||
        localStorage.getItem(key) === "true"
      );
    }
</script>

<script>
  /* ---------- Topics: familiarity only (no MCQs) ---------- */
  const topics = [
    { id: "uri_scheme", tag: "URIs", q: "Are you familiar with the concept of Uniform Resource Identifier (URI) schemes?" },
    { id: "file_vs_network_uri", tag: "URIs", q: "Do you know the difference between filesystem URIs and remote/network URIs?" },
    { id: "reflection", tag: "Java", q: "Are you familiar with the Java Reflection API?" },
    { id: "visitor_walkFileTree", tag: "Java", q: "Are you familiar with the Visitor design pattern, particularly as used in Java‚Äôs Files.walkFileTree API?" },
    { id: "utf8_utf16", tag: "Unicode", q: "Do you know the difference between UTF-8 and UTF-16 Unicode encodings?" },
    { id: "bitwise_ops", tag: "Bits", q: "Do you know what bitwise operators (e.g., &, |, ^, >>, >>>) do in programming?" },
    { id: "hex_to_dec", tag: "Number Systems", q: "Do you know how to convert between hexadecimal and decimal numbers without using a calculator?" },
    { id: "quadratic", tag: "Math", q: "Are you familiar with the quadratic formula?" },
    { id: "atan", tag: "Math", q: "Are you familiar with the arctangent (atan) function?" },
    { id: "nan", tag: "Floating Point", q: "Are you familiar with the concept of NaN (Not a Number) and its behavior in Java?" },
    { id: "fp_singularities", tag: "Floating Point", q: "Are you familiar with Java‚Äôs handling of floating-point singularities (such as division by zero)?" }
  ];

  /* ---------- State ---------- */
  const qtext = document.getElementById('qtext');
  const opts  = document.getElementById('opts');
  const bar   = document.getElementById('bar');
  const prevB = document.getElementById('prev');
  const nextB = document.getElementById('next');
  const gotoReviewB = document.getElementById('goto-review');

  let state = { i: 0, answers: {} }; // answers: { [topicId]: 'yes'|'no' }

  function saveState() {
    localStorage.setItem('csKnowledgeSurveyAnswers', JSON.stringify(state.answers));
  }
  function loadState() {
    const saved = localStorage.getItem('csKnowledgeSurveyAnswers');
    if (saved) {
      try { state.answers = JSON.parse(saved) || {}; } catch {}
    }
  }

  function validatePhase4() {
    // all topics must have a 'yes' or 'no'
    for (const t of topics) {
      const v = state.answers[t.id];
      if (v !== 'yes' && v !== 'no') return false;
    }
    return true;
  }

  function render() {
    const t = topics[state.i];
    // progress: current index / total
    bar.style.width = `${(state.i / topics.length) * 100}%`;

    qtext.textContent = t.q;
    opts.innerHTML = '';

    const rec = state.answers[t.id]; // 'yes' | 'no' | undefined
    const yes = document.createElement('label');
    yes.innerHTML = `<input type="radio" name="fam" value="yes" ${rec==='yes'?'checked':''}> Yes`;
    const no  = document.createElement('label');
    no.innerHTML  = `<input type="radio" name="fam" value="no" ${rec==='no'?'checked':''}> No`;

    opts.append(yes, document.createElement('br'), no);

    nextB.disabled = !(rec === 'yes' || rec === 'no');
    prevB.disabled = (state.i === 0);
  }

  opts.addEventListener('change', (e) => {
    if (e.target?.name === 'fam') {
      state.answers[topics[state.i].id] = e.target.value;  // 'yes' | 'no'
      saveState();
      nextB.disabled = false; // enable next as soon as they choose
    }
  });

  nextB.onclick = () => {
    // must pick an option
    const v = state.answers[topics[state.i].id];
    if (v !== 'yes' && v !== 'no') {
      showValidationMessage('Please select Yes or No.');
      return;
    }

    state.i++;
    if (state.i >= topics.length) {
      // completed
      bar.style.width = '100%';
      localStorage.setItem('phase4Complete', 'true');
      document.getElementById('link-review')?.classList.remove('disabled');

      // final UI
      qtext.textContent = 'All done with the familiarity survey!';
      opts.innerHTML = '<div class="hint">Click <strong>Go to Review & Submit</strong> to finish.</div>';
      nextB.style.display = 'none';
      gotoReviewB.style.display = 'inline-block';

      // optional quick summary for your server-side inspection
      const topicIds = Object.keys(state.answers);
      let famYes = 0;
      topicIds.forEach(id => { if (state.answers[id] === 'yes') famYes++; });
      localStorage.setItem('csKnowledgeSurveySummary', JSON.stringify({ totalTopics: topics.length, famYes }));

      return;
    }
    render();
  };

  function goPrev() {
    if (state.i > 0) {
      state.i--;
      render();
    }
  }
  window.goPrev = goPrev; // keep your onclick="goPrev()"

  function finishPhase4() {
    // Ensure flag + nav then go to Review
    if (validatePhase4()) {
      localStorage.setItem('phase4Complete', 'true');
      document.getElementById('link-review')?.classList.remove('disabled');
    }
    window.location.href = 'review.html';
  }
  window.finishPhase4 = finishPhase4; // keep your onclick

  /* ---------- Save progress ping (same pattern) ---------- */
  function saveToServer() {
    const name = sessionStorage.getItem('participantName') || localStorage.getItem('participantName') || 'Anonymous';
    const username = localStorage.getItem('username') || localStorage.getItem('usernameS') || 'anonymous';

    // Phase 1 scaffold (kept consistent with your payload shape)
    const phase1 = {};
    for (let i = 1; i <= 8; i++) {
      const summary = sessionStorage.getItem(`summary${i}`) || localStorage.getItem(`summary${i}`) || '';
      const comp = sessionStorage.getItem(`compSummary${i}`) || localStorage.getItem(`compSummary${i}`) || '';
      phase1[`snippet${i}`] = { summary, comprehensibility: comp };
    }

    let phase2 = {}, phase3 = {};
    try { phase2 = JSON.parse(sessionStorage.getItem('phase3_ranking') || localStorage.getItem('phase3_ranking') || '{}'); } catch {}
    try { phase3 = JSON.parse(sessionStorage.getItem('phase3_reasoning') || localStorage.getItem('phase3_reasoning') || '{}'); } catch {}

    const flags = {
      phase1Complete: sessionStorage.getItem('phase1Complete') || localStorage.getItem('phase1Complete') || 'false',
      phase2Complete: sessionStorage.getItem('phase2Complete') || localStorage.getItem('phase2Complete') || 'false',
      phase3Complete: sessionStorage.getItem('phase3Complete') || localStorage.getItem('phase3Complete') || 'false',
      phase4Complete: localStorage.getItem('phase4Complete') || 'false',
      codeTheme: localStorage.getItem('codeTheme') || 'light',
      submitted: '0',
    };

    const payload = { username, participantName: name, phase1, phase2, phase3, ...flags };
    const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
    navigator.sendBeacon('/submit_final', blob);
  }
  window.addEventListener('beforeunload', saveToServer);

  /* ---------- Validation modal ---------- */
  function showValidationMessage(msg) {
    document.getElementById('validation-message').textContent = msg;
    document.getElementById('validation-modal').style.display = 'block';
  }
  window.showValidationMessage = showValidationMessage;

  /* ---------- Onload: nav + enable Review when done ---------- */
  window.onload = () => {
    if (typeof applyTheme === 'function') applyTheme?.();
    if (typeof displayUserName === 'function') displayUserName?.();

    // Enable nav based on earlier flags
    if (sessionStorage.getItem('phase1Complete') === 'true' || localStorage.getItem('phase1Complete') === 'true') {
      document.getElementById('link-phase2')?.classList.remove('disabled');
    }
    if (sessionStorage.getItem('phase2Complete') === 'true' || localStorage.getItem('phase2Complete') === 'true') {
      document.getElementById('link-phase3')?.classList.remove('disabled');
    }
    if (sessionStorage.getItem('phase3Complete') === 'true' || localStorage.getItem('phase3Complete') === 'true') {
      document.getElementById('link-phase4')?.classList.remove('disabled');
    }

    // Highlight Phase 4 tab
    const current = window.location.pathname.split('/').pop() || '';
    if (current.includes('phase4')) {
      document.getElementById('link-phase4')?.classList.add('active');
    }

    // Load answers, render first question
    loadState();
    render();

    // If already complete (all answered), set flags and show Go To Review
    const done = validatePhase4();
    if (done) {
      localStorage.setItem('phase4Complete', 'true');
      document.getElementById('link-review')?.classList.remove('disabled');
      gotoReviewB.style.display = 'inline-block';
    } else {
      localStorage.setItem('phase4Complete', 'false');
      gotoReviewB.style.display = 'none';
    }

    // Auto-save every 2 minutes
    // setInterval(() => {
    //   try { saveToServer(); console.log('[Auto-Save] Progress saved to server.'); }
    //   catch (e) { console.warn('[Auto-Save] Failed to save:', e); }
    // }, 120000);

    window.addEventListener('beforeunload', saveToServer);

  };
</script>

</body>
</html>
