<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Eligibility Check</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
      color: #333;
    }

    .instructions,
    .email-box,
    .survey-box,
    .slots-box {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    button {
      padding: 10px 20px;
      margin-top: 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    .day-card {
      background-color: #eaeaea;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .time-slot {
      display: inline-block;
      margin: 5px;
      padding: 10px 16px;
      border-radius: 6px;
      background-color: #ccc;
      cursor: pointer;
    }

    .time-slot.selected {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 400px;
      text-align: center;
    }

    .input-field {
      width: 100%;
      padding: 10px 14px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      margin-top: 8px;
      margin-bottom: 16px;
      background-color: #fff;
      color: #333;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-field:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 4px rgba(76, 175, 80, 0.4);
    }

    .input-field {
      width: 100%;
      padding: 12px 14px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 10px;
      margin-bottom: 16px;
      background-color: #fff;
      color: #333;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-field:focus {
      border-color: #4CAF50;
      outline: none;
      box-shadow: 0 0 4px rgba(76, 175, 80, 0.4);
    }

    .full-width-btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .full-width-btn:hover {
      background-color: #45a049;
    }

    .modal.hidden {
      display: none !important;
    }

    .success-message {
      position: relative;
      background-color: #e6f9ec;
      color: #2e7d32;
      border: 1px solid #2e7d32;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 16px;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .success-message .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      color: #2e7d32;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      margin: 0;
    }

    .success-message .close-btn:hover {
      color: #1b5e20;
    }

    .confirm-box,
    .final-box {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .confirm-box a {
      color: #4CAF50;
      margin-left: 10px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
    }

    .confirm-box a:hover {
      text-decoration: underline;
    }

    .final-box button {
      margin-top: 10px;
    }

    input.input-error {
      border: 2px solid red;
      background-color: #ffe6e6;
    }

    #warning-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #warning-modal .modal-content {
      background-color: white;
      padding: 20px 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    @keyframes glowPulse {
      0% {
        box-shadow: 0 0 10px #4CAF50;
      }

      100% {
        box-shadow: 0 0 20px #4CAF50, 0 0 30px #4CAF50;
      }
    }

    #email {
      animation: glowPulse 1.5s infinite alternate;
    }

    button:active {
      transform: scale(0.97);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) inset;
    }

      .consent-container {
    max-width: 800px;
    margin: 0 auto;
    border: 2px solid #ccc;
    padding: 20px;
    border-radius: 10px;
    font-family: Arial, sans-serif;
    background: #fff;
    overflow-y: auto;
    max-height: 80vh;
    position: relative;
  }

  .consent-section {
    margin-bottom: 20px;
  }

  .consent-section h3 {
    margin-top: 30px;
  }

  .signature-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #ccc;
  }

  .signature-section label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .signature-section input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  .signature-section .readonly {
    background: #f9f9f9;
    cursor: not-allowed;
  }
  </style>
</head>

<body>


  
<div class="consent-form" style="font-family: Arial, sans-serif; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: auto;">
  <h2 style="text-align: center;">NEW JERSEY INSTITUTE OF TECHNOLOGY</h2>
  <p style="text-align: center;">323 MARTIN LUTHER KING BLVD.<br>NEWARK, NJ 07102</p>
  <h3 style="text-align: center;">CONSENT TO PARTICIPATE IN A RESEARCH STUDY</h3>
  <h4>TITLE OF STUDY: Comparing Proxies for Code Comprehension</h4>

  <p><strong>I,</strong> <span style="border-bottom: 1px solid #000; display: inline-block; width: 300px;"></span>, have been asked to participate in a research study under the direction of Dr. Martin Kellogg.</p>

  <h4>PURPOSE</h4>
  <p>The purpose of this study is to investigate the effectiveness of existing code comprehension measures in assessing the difficulty in understanding Java code snippets (i.e., code comprehensibility). Specifically, this research aims to determine whether these measures can reliably predict expert-determined rankings of code comprehensibility, contributing to improved methods for studying code comprehension.</p>

  <h4>DURATION</h4>
  <p>My participation in this study consists mainly of two parts. The first part is the comprehensibility task, which takes approximately 90 minutes to complete. The second part involves reaching consensus agreements over up to four rounds, with each round expected to take less than 30 minutes.</p>

  <h4>BENEFITS FOR SOCIETY AND THE SUBJECT</h4>
  <p>I have been told that the benefits of this research include advancing knowledge on how code is understood by developers, which can advance teaching and research in software engineering. As a participant, I will have the opportunity to contribute my experience and knowledge to code comprehension research and receive a $50 Amazon gift card as compensation for participating in the study. In the event of early withdrawal, I will receive partial compensation proportional to the extent of my participation.</p>

  <h4>PROCEDURES</h4>
  <p>I have been told that, during this study, the following will occur:</p>
  <ul>
    <li>I will participate as one of five expert Java developers in the study. My participation will take place through a secure web-based application (<a href="https://codecomprehensibility.site" target="_blank">https://codecomprehensibility.site</a>).</li>
    <li>I will take part in up to four rounds following the Delphi method, which is designed to gather and refine expert judgments of a set of Java code snippets.</li>
    <li>In the first round, I will read the study instructions, log in using a dedicated username and password, and sign an electronic informed consent form. I will then complete three tasks for each of eight Java code snippets: (1) describe the primary functionality, (2) explain how understandable I find it, and (3) rank all eight snippets based on difficulty using a drag-and-drop interface. I will also provide justifications.</li>
    <li>I can revise my responses before submitting and may update them until the deadline (two weeks after the study begins).</li>
    <li>After the deadline, the team will analyze all responses. If no consensus is found, de-identified summaries and disagreements will be shared.</li>
    <li>I will then review summaries, revise my rankings if desired, and repeat this process up to four rounds.</li>
    <li>If no consensus is reached by round four, a statistical method will be used to create the final ranking.</li>
  </ul>

  <h4>PARTICIPANTS</h4>
  <p>I will be one of about five participants in this study.</p>

  <h4>EXCLUSIONS</h4>
  <p>I will inform the researcher if any of the following apply:</p>
  <ul>
    <li>I am under 18 years of age.</li>
    <li>I have a reading disability or impairment affecting code comprehension tasks.</li>
    <li>I am not comfortable reading English text.</li>
    <li>My background does not include:
      <ul>
        <li>At least five years of Java programming experience, and</li>
        <li>At least one year leading a team of Java programmers within an organization.</li>
      </ul>
    </li>
  </ul>

  <h4>RISKS/DISCOMFORTS</h4>
  <p>This study may involve mild discomfort or fatigue from focusing for extended periods. Breaks will be provided. There may be unknown risks. I understand that I am not covered by NJIT‚Äôs insurance policy for any injury or loss during participation.</p>

  <h4>CONFIDENTIALITY</h4>
  <p>I understand that my participation is confidential but not anonymous. My responses will be linked to my name and email so the research team can contact me. Responses may be shared (after de-identification) with other experts but not linked to my identity. All data will be stored securely on AWS during the study and then transferred to NJIT servers and deleted from AWS. Only the research team will access identifying information.</p>

  <h4>PAYMENT FOR PARTICIPATION</h4>
  <p>I will receive a $50 Amazon gift card after completing the study. If I do not complete all tasks, I will receive partial compensation proportional to my participation.</p>

  <h4>RIGHT TO REFUSE OR WITHDRAW</h4>
  <p>Participation is voluntary. I may withdraw at any time without consequence. The investigator may also withdraw me at any time.</p>

  <h4>INDIVIDUAL TO CONTACT</h4>
  <p>
    For questions about treatment or procedures:<br>
    <strong>Martin Kellogg, Ph.D.</strong><br>
    Assistant Professor of Computer Science<br>
    NJIT, 323 Dr Martin Luther King Jr Blvd, Newark, NJ 07102<br>
    (973) 596-3381<br>
    <a href="mailto:martin.kellogg@njit.edu">martin.kellogg@njit.edu</a> (preferred)
  </p>

  <p>
    For questions about research rights:<br>
    <strong>Office of Research</strong><br>
    NJIT, 323 Martin Luther King Boulevard, Newark, NJ 07102<br>
    (973) 642-4877<br>
    <a href="mailto:irb@njit.edu">irb@njit.edu</a> (preferred)
  </p>

  <h4>SIGNATURE OF PARTICIPANT</h4>
  <p>
    I have read this form and understand it fully. My questions have been answered to my satisfaction. I agree to participate in this research study.
  </p>
  <p>
    Participant Name: <span style="border-bottom: 1px solid #000; display: inline-block; width: 250px;"></span><br><br>
    Signature: <span style="border-bottom: 1px solid #000; display: inline-block; width: 250px;"></span><br><br>
    Date: <span id="consent-date" style="border-bottom: 1px solid #000; display: inline-block; width: 250px;"></span>
  </p>
</div>

<div class="instructions">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>About This Study</h3>
    <button
      style="padding: 6px 12px; font-size: 14px; border-radius: 5px; background-color: #ddd; border: none;color: darkslategrey; cursor: pointer;"
      onclick="toggleInfo(this)">Hide</button>
  </div>
<div id="study-info">
<p><strong>üìò Study Overview:</strong> <p>You have been invited to serve as one of the five expert participants in a study designed to leverage your expertise in helping us conduct research aimed at making code easier for developers to understand.</p></p>

<p><strong>üéØ Goal:</strong> To establish an expert-determined ranking of the comprehensibility of 8 Java code snippets, which will later serve as the ground-truth ranking in a follow-up study involving student participants.</p>

<p><strong>üß† What You'll Do:</strong> You'll review <strong>8 Java code snippets</strong> across up to <strong>3 rounds</strong>, answer a few questions, and rank the snippets based on how easy or difficult they are to understand.</p>

<p><strong>‚è≥ Duration:</strong> Each round is expected to take less than <strong>60 minutes</strong>. You‚Äôll be able to complete each round on your own schedule before the deadline.</p>

<p><strong>üíª Format:</strong> The study is conducted entirely <strong>online</strong>. You'll complete all tasks through our secure web platform, without any live meetings or direct contact with other participants.</p>

<p><strong>üîÅ Process:</strong> After each round, we‚Äôll share anonymized feedback from other experts to help guide consensus on a shared ranking. The study concludes once consensus is reached, or after round 3. (This process is based on the <a href="https://en.wikipedia.org/wiki/Delphi_method" target="_blank">Delphi method</a>)</p>

<p><strong>üéÅ Gift:</strong> While we recognize that we cannot fully compensate you for your valuable time and expertise given our limited research budget, you will receive a $50 Amazon gift card as a token of appreciation after the study concludes.</p>

<p><strong>üîí Confidentiality:</strong> Your responses will be kept confidential and anonymized in all communications and publications. Only the research team will have access to your identifiable information.</p>


      <p><a href="#"
          onclick="document.getElementById('detailed-info').style.display='block'; this.style.display='none'; return false;">üìò
          Learn more about what to expect</a></p>

      <div id="detailed-info" style="display: none;">
        <p>Here's what will be involved:</p>

<ul>
  <li>This study will involve five experts like yourself.</li>
<li>Our goal is to establish an expert-determined ranking of the comprehensibility of 8 Java code snippets.</li>
<li class="summary-text">After agreeing to participate, you will receive an email containing your username, password, and a link to complete Round 1.</li>
  <li class="detailed-only"><strong>Your task in Round 1 (approximately 60 minutes):</strong>
    <ul>
      <li class="detailed-only"><strong>Phase 1:</strong> Review each code snippet and write a short summary. Also provide your assessment of how easy or difficult it is to understand.</li>
      <li class="detailed-only"><strong>Phase 2:</strong> Rank all 8 snippets from easiest to hardest to understand. You may group snippets together if you feel they are similarly understandable.</li>
      <li class="detailed-only"><strong>Phase 3:</strong> Explain your reasoning behind your ranking and any groupings you formed.</li>
    </ul>
  </li>

  <li class="detailed-only">After all experts have submitted their Round 1 responses, the research team will assess whether a consensus on a shared ranking has been reached. If so, the study concludes. If not, another round will be initiated via email.</li>

  <li class="detailed-only"><strong>In Rounds 2 (and possibly 3) (approximately 60 minutes each):</strong>
    <ul>
      <li class="detailed-only"><strong>Phase 1:</strong> Review your own and other experts‚Äô anonymized summaries and assessments from the previous round.</li>
      <li class="detailed-only"><strong>Phase 2:</strong> Review your own and other experts‚Äô rankings and the reasoning behind them.</li>
      <li class="detailed-only"><strong>Phase 3:</strong> Reflect on major disagreements between experts, as identified by the research team. You‚Äôll be asked a few questions to share your thoughts.</li>
      <li class="detailed-only"><strong>Phase 4:</strong> Update your ranking of the code snippets, if desired.</li>
      <li class="detailed-only"><strong>Phase 5:</strong> Explain your reasoning behind any changes you made to your ranking or groupings.</li>
    </ul>
  </li>

  <li class="summary-text">After each round, the research team will check for consensus among experts. If consensus is reached, the study will conclude early.</li>

  <li class="summary-text">If consensus is not reached after the third round, a statistical aggregation method will be applied to determine a final expert-informed ranking.</li>
</ul>


        <p>We appreciate your interest, your participation helps advance research in software engineering education!</p>
      </div>
    </div>
  </div>


  <div class="email-box" id="email-box">
    <h2>Check Your Eligibility</h2>
    <input type="email" id="email" placeholder="Enter your email" class="input-field">
    <button onclick="startSurvey()" class="full-width-btn">Check My Eligibility</button>
  </div>

  <div class="survey-box hidden" id="survey-box">
    <h3>Eligibility Questions</h3>
    <div id="question-container"></div>
    <div style="margin-top: 20px;">
      <button onclick="prevQuestion()" id="prevBtn" disabled>Previous</button>
      <button onclick="nextQuestion()" id="nextBtn">Next</button>
    </div>
  </div>

  <div id="eligibility-success" class="success-message hidden">
    <button class="close-btn"
      onclick="document.getElementById('eligibility-success').classList.add('hidden')">‚úï</button>
    üéâ You're eligible to participate in the study! Please finilize your participation by clicking on this button:
  </div>
  <div class="slots-box hidden" id="consent-form">
    
  </div>


  <div class="slots-box hidden" id="slots-box">
    <h3>Select All Your Available Time Slots</h3>
    <div class="day-card">
      <h4>Monday, June 10</h4>
      <div>
        <div class="time-slot" onclick="selectSlot(this)">10:00 AM</div>
        <div class="time-slot" onclick="selectSlot(this)">1:00 PM</div>
        <div class="time-slot" onclick="selectSlot(this)">4:00 PM</div>
      </div>
    </div>
    <div class="day-card">
      <h4>Tuesday, June 11</h4>
      <div>
        <div class="time-slot" onclick="selectSlot(this)">9:00 AM</div>
        <div class="time-slot" onclick="selectSlot(this)">12:00 PM</div>
        <div class="time-slot" onclick="selectSlot(this)">3:00 PM</div>
      </div>
    </div>

    <button onclick="finalizeMultiSlotSelection()">Next</button>

    <p style="margin-top: 1em;">
      <a href="#" onclick="toggleCustomTimeBox(); return false;">None of these work for you?</a>
    </p>

    <div id="custom-time-box"
      style="display: none; margin-top: 1em; border: 1px solid #ccc; padding: 1em; border-radius: 8px;">
      <p><strong>üìÖ Please select all of your free times:</strong></p>

      <div class="day-card">
        <h4>Wednesday, June 12</h4>
        <div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">10:00 AM</div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">1:00 PM</div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">4:00 PM</div>
        </div>
      </div>

      <div class="day-card">
        <h4>Thursday, June 13</h4>
        <div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">9:00 AM</div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">12:00 PM</div>
          <div class="time-slot" onclick="toggleCustomSlot(this)">3:00 PM</div>
        </div>
      </div>

      <button onclick="reviewCustomTime()">Next</button>
    </div>


  </div>

  <!-- Confirmation Section -->
  <div class="confirm-box hidden" id="confirm-box">
    <p><strong>You selected:</strong> <span id="selected-slot-info"></span>
      <a href="#" onclick="changeSlot()">Change date</a>
    </p>
    <label style="display: block; margin: 15px 0;">
      <input type="checkbox" id="notify-checkbox" checked>
      I want to receive notifications about this session through my email "<span id="notify-email"></span>"
    </label>
    <button onclick="finalizeRegistration()">Finalize My Registration</button>
  </div>

  <!-- Final Success Section -->
  <div class="final-box hidden" id="final-box">
    <h3>‚úÖ Registration Received!</h3>
    <p>Thank you! We'll reach out to you soon to confirm the final session time and share the exact room location. It
      will be in one of the rooms at <strong>GITC, NJIT</strong>.</p>
    <p><strong>Selected availability:</strong> <span id="confirmed-session"></span></p>
    <!-- <p>You can add a placeholder to your Google Calendar for now:</p>
    <button onclick="addToGoogleCalendar()">üìÖ Add to Google Calendar</button> -->
  </div>


  <div class="final-box hidden" id="final-box-custom">
    <h3>‚úÖ Submitted!</h3>
    <p>Thank you! Your submission has been received. <strong>We‚Äôll contact you soon to schedule a time.</strong></p>
    <p>The exact room location will be shared in a separate follow-up‚Äîit will be in one of the rooms at <strong>GITC,
        NJIT</strong>.</p>
  </div>

  <div class="slots-box" id="final-confirmation-panel" style="display: none;">
    <p id="final-summary"></p>
    <a href="#" onclick="changeSlotCustom()">Change date</a>
    <button onclick="submitPendingRegistration()">Submit</button>
  </div>



  <div class="modal hidden" id="ineligible-modal">
    <div class="modal-content">
      <h3>Not Eligible</h3>
      <p>Unfortunately, you are not eligible to participate in this study. Thank you for your interest.</p>
      <button onclick="document.getElementById('ineligible-modal').classList.add('hidden')">Close</button>
    </div>
  </div>

  <div class="modal hidden" id="warning-modal">
    <div class="modal-content">
      <p id="warning-message">Placeholder warning text.</p>
      <button onclick="closeWarningModal()">Close</button>
    </div>
  </div>


  <script>
const questions = [
  {
    text: "Have you held a senior-level engineering role or higher in your career?",
    options: [
      { label: "Yes, I‚Äôve been a Senior Software Engineer or held a more advanced title (e.g., Staff Engineer, Tech Lead, Engineering Manager, etc.)" },
      { label: "No, I have not held a senior-level engineering role", ineligible: true }
    ]
  },
  {
    text: "Is Java one of your primary programming languages?",
    options: [
      { label: "Yes" },
      { label: "No", ineligible: true }
    ]
  },
  {
    text: "Have you mentored at least one junior software engineer in a professional setting?",
    options: [
      { label: "Yes" },
      { label: "No", ineligible: true }
    ]
  },
  {
    text: "How many years of professional software development experience do you have?",
    options: [
      { label: "Less than 3 years" },
      { label: "3‚Äì5 years" },
      { label: "6‚Äì10 years" },
      { label: "More than 10 years" }
    ]
  },
  {
    text: "What is your age?",
    options: [
      { label: "Under 18", ineligible: true },
      { label: "18‚Äì20",},
      { label: "21‚Äì24" },
      { label: "25‚Äì30" },
      { label: "31‚Äì40" },
      { label: "Over 40" }
    ]
  },
  {
    text: "Have you been diagnosed with a reading or learning disability, or any condition that affects your ability to read or understand code or instructions?",
    options: [
      { label: "Yes, I have been diagnosed with such a condition", ineligible: true },
      { label: "No, I have not been diagnosed with any such condition" }
    ]
  },
  {
    text: "How comfortable are you with reading English-language text?",
    options: [
      { label: "Not comfortable", ineligible: true },
      { label: "Slightly comfortable" },
      { label: "Moderately comfortable" },
      { label: "Very comfortable" },
      { label: "Native speaker / fluent" }
    ]
  }
];

    let currentQuestion = 0;
    let answers = [];

    function startSurvey() {

      const emailInput = document.getElementById('email');
      const email = emailInput.value.trim().toLowerCase();


      // Remove any prior error indication
      emailInput.classList.remove("input-error");

      const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!isValidEmail) {
        emailInput.classList.add("input-error");
        showWarningModal("Please enter a valid email address.");
        emailInput.focus();
        return;
      }

      //   if (!email.endsWith("@njit.edu")) {
      //     emailInput.classList.add("input-error");
      //     showWarningModal("Please use your NJIT email address (e.g., yourname@njit.edu).");
      //     emailInput.focus();
      //     return;
      //   }

      localStorage.setItem("student_email", email);
      document.getElementById('email-box').classList.add('hidden');
      document.getElementById('survey-box').classList.remove('hidden');
      hideStudyInfoIfVisible();
      showQuestion();
    }



    function showQuestion() {
      const q = questions[currentQuestion];
      const container = document.getElementById('question-container');
      let html = `<p><strong>${q.text}</strong></p>`;
      q.options.forEach((opt, i) => {
        const checked = answers[currentQuestion] === i ? 'checked' : '';
        html += `<label><input type="radio" name="q${currentQuestion}" value="${i}" ${checked}> ${opt.label}</label><br>`;
      });
      container.innerHTML = html;

      document.getElementById('prevBtn').disabled = currentQuestion === 0;
      document.getElementById('nextBtn').innerText = currentQuestion === questions.length - 1 ? 'Check Eligibility' : 'Next';
    }

    function nextQuestion() {
      const selected = document.querySelector(`input[name="q${currentQuestion}"]:checked`);
      if (!selected) return alert("Please select an option.");
      answers[currentQuestion] = parseInt(selected.value);
      if (currentQuestion === questions.length - 1) {
        checkEligibility();
      } else {
        currentQuestion++;
        showQuestion();
      }
    }

    function prevQuestion() {
      if (currentQuestion > 0) currentQuestion--;
      showQuestion();
    }

    function checkEligibility() {
      for (let i = 0; i < answers.length; i++) {
        const opt = questions[i].options[answers[i]];
        if (opt.ineligible) {
          document.getElementById('survey-box').classList.add('hidden');
          document.getElementById('ineligible-modal').classList.remove('hidden');
          return;
        }
      }
      document.getElementById('survey-box').classList.add('hidden');
      document.getElementById('eligibility-success').classList.remove('hidden');
      document.getElementById('slots-box').classList.remove('hidden');
    }


    // function selectSlot(el) {
    //   el.classList.toggle('selected');

    //   // Gather all selected slots
    //   const selectedEls = document.querySelectorAll('.slots-box .time-slot.selected');
    //   if (selectedEls.length === 0) return;

    //   const selectedSlots = Array.from(selectedEls).map(el => {
    //     const dayText = el.closest('.day-card').querySelector('h4').innerText;
    //     return `${dayText} at ${el.innerText}`;
    //   });

    //   localStorage.setItem("selected_slot", selectedSlots.join(", "));

    //   // Update confirmation UI
    //   document.getElementById('eligibility-success').classList.add('hidden');
    //   document.getElementById('slots-box').classList.add('hidden');
    //   document.getElementById('selected-slot-info').innerText = selectedSlots.join(", ");
    //   document.getElementById('notify-email').innerText = localStorage.getItem("student_email");
    //   document.getElementById('confirm-box').classList.remove('hidden');
    // }


    function finalizeRegistration() {
      const notify = document.getElementById('notify-checkbox').checked;
      localStorage.setItem("notify_opt_in", notify);

      // Call registration submit before showing final confirmation
      submitRegistrationData().then(success => {
        if (success) {
          document.getElementById('confirm-box').classList.add('hidden');
          document.getElementById('final-box').classList.remove('hidden');
          const selectedSlot = localStorage.getItem("selected_slot");
          const sessionText = `${selectedSlot}`;
          document.getElementById("confirmed-session").innerText = sessionText;
        } else {
          alert("‚ùå Something went wrong while registering. Please try again or contact the research team.");
        }
      });
    }


    function addToGoogleCalendar() {
      const selected = localStorage.getItem("selected_slot"); // e.g., "Monday, June 10 at 10:00 AM"
      if (!selected) return alert("No time slot selected.");

      const [dayText, timeText] = selected.split(" at ");
      const dateMap = {
        "Monday, June 10": "20250610",
        "Tuesday, June 11": "20250611"
      };
      const baseDate = dateMap[dayText.trim()];
      if (!baseDate) return alert("Invalid date.");

      // Parse time (e.g., "1:00 PM")
      const [hourPart, minutePartWithSuffix] = timeText.trim().split(":");
      const minutes = minutePartWithSuffix.slice(0, 2);
      const suffix = minutePartWithSuffix.trim().slice(-2); // AM or PM
      let hour = parseInt(hourPart);

      if (suffix === "PM" && hour !== 12) hour += 12;
      if (suffix === "AM" && hour === 12) hour = 0;

      const startHourStr = hour.toString().padStart(2, '0');
      const startMinuteStr = minutes.padStart(2, '0');
      const startTime = `${baseDate}T${startHourStr}${startMinuteStr}00`;

      // Add 90 minutes for end time
      const startDate = new Date(`${baseDate.slice(0, 4)}-${baseDate.slice(4, 6)}-${baseDate.slice(6)}T${startHourStr}:${startMinuteStr}:00`);
      const endDate = new Date(startDate.getTime() + 90 * 60 * 1000); // 90 min in ms
      const endTime = `${endDate.getFullYear()}${(endDate.getMonth() + 1).toString().padStart(2, '0')}${endDate.getDate().toString().padStart(2, '0')}T${endDate.getHours().toString().padStart(2, '0')}${endDate.getMinutes().toString().padStart(2, '0')}00`;

      // Build Google Calendar URL
      const title = encodeURIComponent("Code Comprehension Session");
      const location = encodeURIComponent("To be declared");
      const details = encodeURIComponent("You registered for a code comprehension session. We'll contact you with the exact room. It will be in GITC at NJIT.");
      const calendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=${details}&location=${location}`;

      window.open(calendarUrl, "_blank");
    }


    function toggleInfo(btn) {
      const info = document.getElementById('study-info');
      if (info.classList.contains('hidden')) {
        info.classList.remove('hidden');
        btn.innerText = "Hide";
      } else {
        info.classList.add('hidden');
        btn.innerText = "Show";
      }
    }

    function toggleStudyInfo() {
      const info = document.getElementById('study-info');
      const button = document.getElementById('toggleInfoButton');

      if (info.classList.contains('hidden')) {
        info.classList.remove('hidden');
        button.innerText = "Hide";
      } else {
        info.classList.add('hidden');
        button.innerText = "Show";
      }
    }

    function hideStudyInfoIfVisible() {
      const info = document.getElementById('study-info');
      const button = document.getElementById('toggleInfoButton');

      if (!info.classList.contains('hidden')) {
        info.classList.add('hidden');
        if (button) button.innerText = "Show";
      }
    }



    function submitRegistrationData() {
      const email = localStorage.getItem("student_email") || "unknown";
      const notify = localStorage.getItem("notify_opt_in") === "true";
      const selectedSlot = localStorage.getItem("selected_slot") || "unspecified";

      const eligibilityResponses = questions.map((q, index) => {
        const selectedIndex = answers[index];
        return {
          question: q.text,
          selectedOption: q.options[selectedIndex]?.label || "No answer"
        };
      });

      const payload = {
        email: email,
        notify: notify,
        selectedSlot: selectedSlot,
        eligibilityResponses: eligibilityResponses,
        submitted: true,
        event: "availability" // or "cancel" or "modify"
      };


      return fetch("https://codecomprehensibility.site/register_student", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
        .then(res => res.ok)
        .catch(err => {
          console.error("‚ùå Network error:", err);
          return false;
        });
    }

    function showWarningModal(message) {
      document.getElementById("warning-message").textContent = message;
      document.getElementById("warning-modal").classList.remove("hidden");
    }

    function closeWarningModal() {
      document.getElementById("warning-modal").classList.add("hidden");
    }

    document.getElementById('email').addEventListener('input', function () {
      const value = this.value.trim().toLowerCase();
      const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);

      // If the input is now a valid email OR ends with '@njit.edu', remove error styling
      if (isValidEmail) {
        this.classList.remove('input-error');
      }
    });


    function changeSlot() {
      // Hide confirmation section and show time slot selection again
      document.getElementById('confirm-box').classList.add('hidden');
      document.getElementById('slots-box').classList.remove('hidden');
      document.getElementById('final-confirmation-panel').style.display = 'none';

    }

    function changeSlotCustom() {
      // Hide confirmation section and show time slot selection again
      document.getElementById('confirm-box').classList.add('hidden');
      document.getElementById('slots-box').classList.remove('hidden');
      document.getElementById('final-confirmation-panel').style.display = 'none';
      toggleCustomTimeBox();

    }

  </script>

  <script>
    function toggleCustomTimeBox() {
      const box = document.getElementById('custom-time-box');
      box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    }

    function reviewCustomTime() {
      const selected = Array.from(document.querySelectorAll('#custom-time-box .time-slot.selected'))
        .map(el => {
          const day = el.closest('.day-card').querySelector('h4').innerText;
          return `${day} at ${el.innerText}`;
        });

      if (selected.length === 0) {
        alert("Please select at least one time slot.");
        return;
      }

      window.customEventData = {
        event: "pending",
        availabilityNote: selected
      };

      document.getElementById('eligibility-success').classList.add('hidden');

      goToFinalStepWithPendingEvent();
    }


    function goToFinalStepWithPendingEvent() {
      const selectedTimes = Array.from(document.querySelectorAll('#custom-time-box .time-slot.selected'))
        .map(slot => {
          const day = slot.closest('.day-card').querySelector('h4').innerText;
          return `${day} at ${slot.innerText.trim()}`;
        });

      if (selectedTimes.length === 0) {
        alert("Please select at least one available time.");
        return;
      }

      window.customEventData = {
        event: "pending",
        availabilityNote: selectedTimes
      };

      const formatted = selectedTimes.map(t => `<li>${t}</li>`).join("");

      document.getElementById('final-summary').innerHTML = `
    <p><strong>üïí Please review your selected availability before submitting:</strong></p>
    <ul>${formatted}</ul>
    <p>Click ‚ÄúSubmit‚Äù below and we‚Äôll follow up to schedule your session based on your availability.</p>
  `;

      document.getElementById('slots-box').classList.add('hidden');
      document.getElementById('custom-time-box').style.display = 'none';
      document.getElementById('final-confirmation-panel').style.display = 'block';
    }



    function submitPendingRegistration() {
      const email = document.getElementById('email').value;
      const payload = {
        email: email,
        event: "pending",
        customAvailability: window.customEventData.availabilityNote.join(", "),
        submitted: true
      };

      fetch("/register_student", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).then(response => {
        if (response.ok) {
          document.getElementById('final-confirmation-panel').style.display = 'none';
          document.getElementById('final-box-custom').classList.remove('hidden');

        } else {
          alert("Something went wrong. Please try again.");
        }
      });
    }

    function toggleCustomSlot(el) {
      el.classList.toggle('selected');
    }


    function finalizeMultiSlotSelection() {
      const selectedEls = document.querySelectorAll('.slots-box .time-slot.selected');
      if (selectedEls.length === 0) {
        alert("Please select at least one time slot.");
        return;
      }

      const selectedSlots = Array.from(selectedEls).map(el => {
        const dayText = el.closest('.day-card').querySelector('h4').innerText;
        return `${dayText} at ${el.innerText}`;
      });

      localStorage.setItem("selected_slot", selectedSlots.join(", "));

      // Go to confirmation step
      document.getElementById('slots-box').classList.add('hidden');
      document.getElementById('eligibility-success').classList.add('hidden');
      document.getElementById('selected-slot-info').innerText = selectedSlots.join(", ");
      document.getElementById('notify-email').innerText = localStorage.getItem("student_email");
      document.getElementById('confirm-box').classList.remove('hidden');
    }


    function selectSlot(el) {
      el.classList.toggle('selected');
    }
  </script>

  <footer
    style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 14px; color: #666;">
    Please contact us if you have any questions or issues: <a href="mailto:ea442@njit.edu">ea442@njit.edu</a>
  </footer>
</body>

</html>