<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expert Instructions</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
      color: #333;
    }
    .instructions {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 10px #4CAF50;
      animation: glowPulse 1.5s infinite alternate;
    }
    @keyframes glowPulse {
      0% { box-shadow: 0 0 10px #4CAF50; }
      100% { box-shadow: 0 0 20px #4CAF50, 0 0 30px #4CAF50; }
    }
    button:hover {
      background-color: #45a049;
    }
    a {
      color: #4CAF50;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

  .steps-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 16px;
  }
  .steps-table td {
    padding: 12px;
    vertical-align: top;
  }
  .step-number {
    background-color: #f4c542;
    font-weight: bold;
    width: 40px;
    text-align: center;
    border-radius: 6px;
  }
  .step-desc {
    background-color: #fff7e6;
  }
  .step-time {
    background-color: #f4c542;
    text-align: center;
    font-weight: bold;
    border-radius: 6px;
    width: 80px;
  }

  .tooltip {
  position: relative;
  display: inline-block;
  cursor: help;
  border-bottom: 1px dotted #555;
  }

  .tooltip .tooltip-text {
    visibility: hidden;
    width: 260px;
    background-color: #333;
    color: #fff;
    text-align: left;
    padding: 8px 10px;
    border-radius: 6px;
    position: absolute;
    z-index: 1;
    bottom: 125%; /* Show above the word */
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }

  .table-container {
    display: flex;
    justify-content: center;    /* center the table horizontally */
    margin: 20px auto;
  }

  .device-warning {
    display: flex;
    align-items: center;
    gap: 12px;
    background-color: #fff3cd;
    color: #856404;
    border-left: 6px solid #ffeeba;
    padding: 12px 16px;
    margin: 20px 0;
    border-radius: 6px;
    font-size: 16px;
  }

  .device-icon {
    font-size: 24px;
  }

  .deadline-box {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  background-color: #fff3f3;
  color: #a94442;
  border-left: 6px solid #f44336;
  padding: 14px 16px;
  margin: 20px 0;
  border-radius: 6px;
  font-size: 16px;
}

.deadline-icon {
  font-size: 28px;
  line-height: 1;
}

.deadline-date {
  color: #d32f2f;
  font-weight: bold;
}

.no-timer-note {
  background-color: #e8f5e9;
  color: #2e7d32;
  border-left: 5px solid #66bb6a;
  padding: 12px 16px;
  border-radius: 6px;
  margin-top: 10px;
  font-size: 15.5px;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.study-notes {
  background-color: #fefefe;
  border-left: 5px solid #4CAF50;
  padding: 16px 20px;
  border-radius: 8px;
  margin: 30px 0;
  font-size: 15.5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.note-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 12px;
}

.note-icon {
  font-size: 20px;
  line-height: 1.4;
}

.note-text {
  color: #333;
}



</style>
</head>
<body>

<div class="instructions">
<h2>Task Overview</h2>

<p>Our goal is to develop an expert-determined ranking of 
<span class="tooltip">code snippets
  <span class="tooltip-text">A small, self-contained Java method from real-world open-source projects.</span>
</span> based on their 
<span class="tooltip">comprehensibility
  <span class="tooltip-text">How easy a snippet is to understand, as judged by experienced developers.</span>
</span>.
</p>

<p>To reduce bias and improve reliability, we invited multiple experts ‚Äî including you ‚Äî to complete the same task set. We follow a structured protocol inspired by the <a href="https://en.wikipedia.org/wiki/Delphi_method" target="_blank">Delphi method</a>, which aggregates expert consensus through multiple rounds.</p>

<h3>What You'll Do</h3>
<p>
  The current task consists of three main phases and involves evaluating a total of <strong>8 code snippets</strong>. Your total time commitment is approximately <strong>55 minutes</strong>. 
  Additional tasks may be introduced in future rounds‚Äîsee the <a href="#post-submission">What Happens After You Submit Your Responses</a> section for more details.
</p>

<div class="table-container">
  <table class="steps-table">
    <tr>
      <th style="width: 100px;">Phase</th>
      <th>Description</th>
      <th style="width: 100px;">Time</th>
    </tr>
    <tr>
      <td class="step-number">Phase 1</td>
      <td class="step-desc">
        Review each code snippet and provide a short summary along with your assessment of how understandable it is.
      </td>
      <td class="step-time">20 mins</td>
    </tr>
    <tr>
      <td class="step-number">Phase 2</td>
      <td class="step-desc">
        Rank the snippets from most to least comprehensible. You can group snippets that feel equally understandable.
      </td>
      <td class="step-time">15 mins</td>
    </tr>
    <tr>
      <td class="step-number">Phase 3</td>
      <td class="step-desc">
        Explain your reasoning behind the rankings. Describe why snippets were grouped and how you compared them.
      </td>
      <td class="step-time">15 mins</td>
    </tr>
    <tr>
      <td class="step-number">Submission</td>
      <td class="step-desc">
        Review and submit your answers. You may revise and resubmit anytime before the deadline.
      </td>
      <td class="step-time">5 mins</td>
    </tr>
  </table>
</div>

<div class="study-notes">

  <div class="note-item">
    <span class="note-icon">‚è±Ô∏è</span>
    <span class="note-text">
      <strong>Timing:</strong> The times listed in the table are estimates. There are no timers or time restrictions ‚Äî you may take as much time as needed to complete each phase before the deadline.
    </span>
  </div>

  <div class="note-item">
    <span class="note-icon">üíª</span>
    <span class="note-text">
      <strong>Device Requirement:</strong> Please use a <strong>desktop or laptop</strong> with a web browser (<strong>Chrome preferred</strong>) to complete this study.
    </span>
  </div>

  <div class="note-item">
    <span class="note-icon">üìÖ</span>
    <span class="note-text">
      <strong>Submission Deadline:</strong> All responses must be submitted by <span style="color: #d32f2f; font-weight: bold;">May 20, 2025</span>.
    </span>
  </div>

</div>

<details style="margin-top: 20px;" id="post-submission">
  <summary style="font-weight: bold; font-size: 16px; cursor: pointer;">
    What Happens After You Submit Your Responses (click to expand)
  </summary>
  <ul style="margin-top: 10px;">
    <li>After all submissions are received, we will analyze the expert rankings.</li>
    <li>If unanimous agreement is reached, the study will conclude.</li>
    <li>If not, we will initiate follow-up rounds with anonymized feedback from peers.</li>
    <li>You may revise your rankings based on this feedback.</li>
    <li>We may conduct up to three rounds of feedback and refinement.</li>
    <li>If consensus is still not achieved, we will use statistical aggregation to finalize the results.</li>
    <li>We may revise or replace code snippets that experts report as too similar to distinguish.</li>
  </ul>
</details>

<h3>Definitions</h3>
<div style="background: #f0f8ff; border-left: 4px solid #4CAF50; padding: 15px; margin-bottom: 20px;">
  <p><strong>Code Comprehensibility</strong>: How easy a snippet is to understand, as judged by experienced developers. This includes clarity of structure, naming, and logic. There is no single standard ‚Äî your expert perspective defines it.</p>
  <p><strong>Code Snippet</strong>: A small, self-contained Java method drawn from real-world open-source projects. All 8 snippets are independent and carefully selected.</p>
</div>

<section id="next-step" style="margin-top: 40px; padding: 24px; background-color: #f9f9f9; border-top: 2px solid #ccc; border-radius: 8px;">
  <h2>Let‚Äôs Get Started</h2>

  <!-- Login Section -->
  <form id="login-box" onsubmit="return loginAndProceed(event)" autocomplete="on">
    <p><strong>Please enter your username and password to start the study:</strong></p>

    <input type="text" id="username" name="username" placeholder="Username" autocomplete="username"
          style="padding: 8px; font-size: 16px; width: 300px; border-radius: 5px; border: 1px solid #ccc;"><br><br>

    <input type="password" id="password" name="password" placeholder="Password" autocomplete="current-password"
          style="padding: 8px; font-size: 16px; width: 300px; border-radius: 5px; border: 1px solid #ccc;"><br>

    <p id="login-error" style="color: red; display: none;"></p>

    <p style="margin-top: 20px;">
      <button type="submit">Login and Start Phase 1</button>
    </p>
  </form>

  <!-- Post-login Proceed Button -->
  <div id="proceed-box" style="display: none; margin-top: 40px;">
    <p>Welcome back, <span id="participant-display-name" style="font-weight: bold;"></span>!</p>
    <button onclick="proceedToPhase1()">Proceed to Phase 1</button>
  </div>

</section>


</div>


<footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 14px; color: #666;">
  Please contact us if you have any questions or issues: <a href="mailto:ea442@njit.edu">ea442@njit.edu</a>
</footer>


<script>
  function setCookie(name, value, days = 30) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = `${name}=${encodeURIComponent(value)}; path=/; expires=${expires}`;
  }
  
  async function loginAndProceed(event) {
    event.preventDefault();

    const username = document.getElementById('username').value.trim().toLowerCase();
    const password = document.getElementById('password').value.trim();
    const errorDiv = document.getElementById('login-error');
    errorDiv.style.display = 'none';

    if (!username || !password) {
      errorDiv.textContent = "Please enter both username and password.";
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const response = await fetch('https://codecomprehensibility.site/get_snippet_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (!response.ok) throw new Error("Invalid credentials");

      const data = await response.json();
      const { participantName, snippetOrder } = data;

      if (!participantName || !snippetOrder) throw new Error("Incomplete response");

      sessionStorage.setItem('participantName', participantName);
      sessionStorage.setItem('snippetOrder', JSON.stringify(snippetOrder));
      sessionStorage.setItem('username', username);

      setCookie('participantName', participantName);
      setCookie('snippetOrder', JSON.stringify(snippetOrder));
      setCookie('username', username);
      loadPreviousData();

      window.location.href = 'phase1.html';

    } catch (err) {
      console.error(err);
      errorDiv.textContent = "Login failed. Please check your credentials.";
      errorDiv.style.display = 'block';
    }
  }

  function loadPreviousData() {
    const username = sessionStorage.getItem('username') || getCookie('username');
    if (!username) {
      alert("Username not found.");
      return;
    }

    fetch('https://codecomprehensibility.site/get_latest_submission', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })  // ‚úÖ Correct key
    })
    .then(res => res.ok ? res.json() : Promise.reject("Not found"))
    .then(data => {
      console.log("Loaded data:", data);

      // Phase 1: restore summary + compSummary per snippet
      Object.entries(data.phase1 || {}).forEach(([key, value]) => {
        const i = key.replace('snippet', '');
        const summary = value.summary || '';
        const comp = value.comprehensibility || '';

        sessionStorage.setItem(`summary${i}`, summary);
        sessionStorage.setItem(`compSummary${i}`, comp);
        setCookie(`summary${i}`, encodeURIComponent(summary), 30);
        setCookie(`compSummary${i}`, encodeURIComponent(comp), 30);
      });

      // Phase 2 and 3
      if (data.phase2) {
        const p2 = JSON.stringify(data.phase2);
        sessionStorage.setItem('phase3_ranking', p2);
        setCookie('phase3_ranking', p2, 30);
      }

      if (data.phase3) {
        const p3 = JSON.stringify(data.phase3);
        sessionStorage.setItem('phase3_reasoning', p3);
        setCookie('phase3_reasoning', p3, 30);
      }

      // Participant name
      if (data.participantName) {
        sessionStorage.setItem('participantName', data.participantName);
        setCookie('participantName', data.participantName, 30);
      }

      // Snippet order
      if (data.snippetOrder) {
        const order = JSON.stringify(data.snippetOrder);
        sessionStorage.setItem('snippetOrder', order);
        setCookie('snippetOrder', order, 30);
      }

      // ‚úÖ Restore additional flags
      if ('phase1Complete' in data) {
        sessionStorage.setItem('phase1Complete', data.phase1Complete);
        setCookie('phase1Complete', data.phase1Complete, 30);
      }
      if ('phase2Complete' in data) {
        sessionStorage.setItem('phase2Complete', data.phase2Complete);
        setCookie('phase2Complete', data.phase2Complete, 30);
      }
      if ('phase3Complete' in data) {
        sessionStorage.setItem('phase3Complete', data.phase3Complete);
        setCookie('phase3Complete', data.phase3Complete, 30);
      }

      if ('codeTheme' in data) {
        localStorage.setItem('codeTheme', data.codeTheme); // No cookie needed
      }
      if ('submitted' in data) {
        sessionStorage.setItem('submitted', data.submitted);
        setCookie('submitted', data.submitted, 30);
      }
      console.log("Previous data loaded successfully.");
    })
    .catch(() => console.log("Could not load previous submission."));
  }


  </script>
  

<script>
  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
  }

  function isLoggedIn() {
    const name = sessionStorage.getItem('participantName') || getCookie('participantName');
    const order = sessionStorage.getItem('snippetOrder') || getCookie('snippetOrder');
    return name && order;
  }

  window.onload = () => {
    if (isLoggedIn()) {
      const name = sessionStorage.getItem('participantName') || getCookie('participantName');
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('proceed-box').style.display = 'block';
      document.getElementById('participant-display-name').textContent = name;
    }
  };

  function proceedToPhase1() {
    window.location.href = 'phase1.html';
  }
</script>

</body>
</html>